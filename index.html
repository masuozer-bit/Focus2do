<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            background: #111111;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #111111;
            color: #e8e8e8;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        @media (min-width: 1200px) {
            .main-layout {
                grid-template-columns: 250px 1fr 250px;
                gap: 30px;
            }

            .container {
                max-width: none;
                padding: 0 30px;
            }
        }

        .left-sidebar, .right-sidebar {
            display: none;
        }

        @media (min-width: 1200px) {
            .left-sidebar, .right-sidebar {
                display: block;
            }
        }

        .sidebar-section {
            background: #242424;
            border: 1px solid #3d3d3d;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .sidebar-button {
            width: 100%;
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            color: #e8e8e8;
            padding: 10px 14px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 13px;
            text-align: left;
            transition: all 0.2s ease;
            margin-bottom: 8px;
        }

        .sidebar-button:hover {
            background: #353535;
            border-color: #4d4d4d;
        }

        .sidebar-button.active {
            background: #3d3d3d;
            border-color: #4d4d4d;
        }

        .category-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
            margin-bottom: 4px;
            font-size: 13px;
        }

        .category-list-item:hover {
            background: #2d2d2d;
        }

        .category-list-item.active {
            background: #3d3d3d;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .stat-item:hover {
            background: #353535;
            border-color: #4d4d4d;
        }

        .stat-item.active {
            background: #3d3d3d;
            border-color: #4d4d4d;
        }

        .stat-label {
            font-size: 12px;
            color: #a8a8a8;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #e8e8e8;
        }

        .stat-item.super-urgent .stat-value {
            color: #ff6b6b;
        }

        .stat-item.urgent .stat-value {
            color: #ffb86b;
        }

        .stat-item.moderate .stat-value {
            color: #ffd96b;
        }

        .stat-item.chill .stat-value {
            color: #88d498;
        }

        .template-item {
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.2s ease;
            position: relative;
        }

        .template-item:hover {
            background: #353535;
            border-color: #4d4d4d;
        }

        .template-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .template-item-title {
            font-size: 15px;
            font-weight: 500;
            color: #e8e8e8;
            margin-bottom: 6px;
        }

        .template-item-description {
            font-size: 12px;
            color: #888888;
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .template-item-meta {
            font-size: 11px;
            color: #a8a8a8;
        }

        .template-manager-modal {
            max-width: 700px;
            max-height: 80vh;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-header-with-action {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #3d3d3d;
        }

        .modal-header-with-action h2 {
            margin: 0;
            font-size: 24px;
        }

        .template-list-scrollable {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            margin-bottom: 20px;
        }

        .template-list-scrollable::-webkit-scrollbar {
            width: 8px;
        }

        .template-list-scrollable::-webkit-scrollbar-track {
            background: #2d2d2d;
            border-radius: 4px;
        }

        .template-list-scrollable::-webkit-scrollbar-thumb {
            background: #4d4d4d;
            border-radius: 4px;
        }

        .template-list-scrollable::-webkit-scrollbar-thumb:hover {
            background: #5d5d5d;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        h1 {
            font-size: 42px;
            font-weight: 600;
            letter-spacing: -0.5px;
            color: #e8e8e8;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 0;
            justify-content: center;
            flex-wrap: nowrap;
        }

        .btn {
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            color: #e8e8e8;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn:hover {
            background: #353535;
            border-color: #4d4d4d;
        }

        .btn:active {
            background: #252525;
            color: #ffffff;
        }

        .btn-primary {
            background: #3d3d3d;
            border: 1px solid #4d4d4d;
            color: #ffffff;
        }

        .btn-primary:hover {
            background: #454545;
            border-color: #5d5d5d;
        }

        .btn-primary:active {
            background: #2d2d2d;
        }

        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 0;
            justify-content: center;
            flex-wrap: nowrap;
        }

        .filter-btn {
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            color: #a8a8a8;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .filter-btn.active {
            background: #3d3d3d;
            color: #ffffff;
            border-color: #4d4d4d;
        }

        .filter-btn:hover {
            background: #353535;
            color: #d8d8d8;
        }

        .filter-btn:active {
            background: #252525;
            color: #ffffff;
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 0;
        }

        .all-controls-wrapper {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        @media (min-width: 1200px) {
            .all-controls-wrapper {
                display: none;
            }
        }

        .divider {
            width: 1px;
            height: 30px;
            background: #3d3d3d;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #242424;
            padding: 40px;
            border-radius: 25px;
            width: 90%;
            max-width: 500px;
            border: 1px solid #3d3d3d;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
        }

        .modal-content h2 {
            margin-bottom: 25px;
            font-size: 24px;
            font-weight: 600;
            color: #e8e8e8;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            color: #a8a8a8;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-radius: 12px;
            color: #e8e8e8;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #5d5d5d;
            background: #323232;
        }

        select option {
            background: #2d2d2d;
            color: #e8e8e8;
        }

        .category-select {
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            color: #e8e8e8;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            min-width: 150px;
        }

        .category-select:hover {
            background: #353535;
            border-color: #4d4d4d;
        }

        .category-select:focus {
            outline: none;
            border-color: #5d5d5d;
            background: #323232;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .time-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .modal-actions .btn {
            flex: 1;
        }

        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-radius: 12px;
        }

        .category-item-name {
            color: #e8e8e8;
            font-size: 14px;
        }

        .category-item-actions {
            display: flex;
            gap: 8px;
        }

        .subtask-field {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: #242424;
            border: 1px solid #3d3d3d;
            border-radius: 12px;
        }

        .subtask-field input {
            flex: 1;
            margin: 0;
        }

        .subtask-field button {
            padding: 8px 12px;
            min-width: auto;
        }

        .weekdays-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .weekday-checkbox {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 10px;
            background: #2d2d2d;
            border: 1px solid #3d3d3d;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .weekday-checkbox:hover {
            background: #353535;
        }

        .weekday-checkbox input[type="checkbox"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 10px 0;
        }

        .checkbox-label input[type="checkbox"] {
            width: auto;
            margin: 0;
            cursor: pointer;
        }

        .checkbox-label span {
            color: #e8e8e8;
            font-size: 14px;
        }

        .tasks-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .category-section {
            background: #242424;
            border-radius: 16px;
            padding: 18px;
            border: 1px solid #3d3d3d;
            grid-column: 1 / -1;
        }

        .category-section .tasks-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .category-header {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #e8e8e8;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-icon {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #888888;
        }

        .task-item {
            background: #2d2d2d;
            border-radius: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            border: 1px solid #3d3d3d;
            transition: all 0.2s ease;
            position: relative;
        }

        .task-item:hover {
            background: #353535;
            border-color: #4d4d4d;
        }

        .task-item:active .task-content {
            opacity: 0.8;
        }

        .task-item.completed {
            opacity: 0.5;
        }

        .task-item.completed .task-title {
            text-decoration: line-through;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .task-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr;
            gap: 5px;
            cursor: pointer;
        }

        .task-title {
            font-size: 15px;
            font-weight: 500;
            color: #e8e8e8;
            line-height: 1.3;
        }

        .task-deadline {
            display: flex;
            align-items: center;
        }

        .task-time {
            color: #a8a8a8;
            font-size: 12px;
            line-height: 1.3;
        }

        .task-time-placeholder {
            height: 16px;
        }

        .task-menu-trigger {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 8px;
            transition: background 0.2s ease;
            user-select: none;
        }

        .task-menu-trigger:hover {
            background: #454545;
        }

        .task-menu-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .subtask-counter {
            min-width: 20px;
            height: 20px;
            background: #3d3d3d;
            border: 1px solid #4d4d4d;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            color: #e8e8e8;
            padding: 0 6px;
            transition: all 0.2s ease;
        }

        .subtask-counter:hover {
            background: #4d4d4d;
            border-color: #5d5d5d;
            transform: scale(1.1);
        }

        .menu-dots {
            font-size: 20px;
            color: #a8a8a8;
            line-height: 1;
            display: block;
        }

        .task-menu {
            position: absolute;
            top: 50px;
            right: 20px;
            background: #242424;
            border: 1px solid #3d3d3d;
            border-radius: 12px;
            padding: 8px;
            z-index: 100;
            min-width: 140px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }

        .task-menu-btn {
            width: 100%;
            background: transparent;
            border: none;
            color: #e8e8e8;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            text-align: left;
            transition: background 0.2s ease;
        }

        .task-menu-btn:hover {
            background: #353535;
        }

        .task-menu-delete {
            color: #ff6b6b;
        }

        .task-menu-delete:hover {
            background: #4a2020;
        }

        .subtasks-modal-content {
            background: #242424;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 70vh;
            border: 1px solid #3d3d3d;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
        }

        .subtasks-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid #3d3d3d;
        }

        .subtasks-modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #e8e8e8;
        }

        .modal-close-btn {
            background: transparent;
            border: none;
            color: #a8a8a8;
            font-size: 32px;
            line-height: 1;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-close-btn:hover {
            background: #353535;
            color: #e8e8e8;
        }

        .subtasks-modal-list {
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .subtasks-modal-list .subtask-item {
            margin-bottom: 0;
        }

        .subtask-item {
            background: #2d2d2d;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 0;
            border: 1px solid #3d3d3d;
            transition: all 0.2s ease;
            position: relative;
        }

        .subtask-item:hover {
            background: #353535;
            border-color: #4d4d4d;
        }

        .subtask-item.completed {
            opacity: 0.5;
        }

        .subtask-item.completed .task-title {
            text-decoration: line-through;
        }

        .task-category-label {
            color: #888888;
            font-size: 10px;
            padding: 3px 8px;
            background: #353535;
            border-radius: 6px;
            display: inline-block;
            width: fit-content;
        }

        .task-description {
            font-size: 11px;
            color: #888888;
            line-height: 1.3;
            margin-top: 2px;
        }

        .task-description-placeholder {
            height: 14px;
        }

        .deadline-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 500;
            background: #353535;
            color: #e8e8e8;
        }

        .deadline-badge.urgent {
            background: #4a2020;
            color: #ff6b6b;
            border: 1px solid #6a3030;
        }

        .deadline-badge.soon {
            background: #4a3820;
            color: #ffb86b;
            border: 1px solid #6a5030;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888888;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
            color: #5d5d5d;
        }

        .empty-state-icon::before {
            content: "—";
        }

        input[type="file"] {
            display: none;
        }

        /* Tablet and medium screens */
        @media (max-width: 1200px) {
            .tasks-container {
                grid-template-columns: repeat(2, 1fr);
            }

            .category-section .tasks-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }

            h1 {
                font-size: 32px;
            }

            .modal-content {
                padding: 30px 20px;
            }

            .time-row {
                grid-template-columns: 1fr;
            }

            .all-controls-wrapper {
                flex-direction: column;
                gap: 10px;
            }

            .divider {
                display: none;
            }

            .btn {
                font-size: 12px;
                padding: 8px 16px;
            }

            .filter-btn {
                font-size: 12px;
                padding: 8px 16px;
            }

            .category-select {
                font-size: 12px;
                padding: 8px 16px;
                min-width: 120px;
            }

            .tasks-container {
                grid-template-columns: 1fr;
            }

            .category-section .tasks-grid {
                grid-template-columns: 1fr;
            }

            .task-item {
                padding: 10px 14px;
                font-size: 13px;
            }

            .task-title {
                font-size: 14px;
            }

            .task-time {
                font-size: 11px;
            }

            .task-description {
                font-size: 10px;
            }

            .deadline-badge {
                font-size: 9px;
                padding: 2px 6px;
            }

            .task-category-label {
                font-size: 9px;
                padding: 2px 6px;
            }
        }

        /* Single column for very small screens */
        @media (max-width: 500px) {
            .all-controls-wrapper {
                gap: 8px;
            }

            .btn, .filter-btn, .category-select {
                font-size: 11px;
                padding: 6px 12px;
            }

            .task-item {
                padding: 8px 12px;
            }

            .task-title {
                font-size: 13px;
            }

            h1 {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
        </header>

        <div class="all-controls-wrapper">
            <div class="controls">
                <button class="btn btn-primary" onclick="openModal()">+ Neue Aufgabe</button>
                <button class="btn" onclick="exportData()">Exportieren</button>
                <button class="btn" onclick="document.getElementById('importFile').click()">Importieren</button>
                <input type="file" id="importFile" accept=".json" onchange="importData(event)">
            </div>
            
            <div class="divider"></div>
            
            <div class="controls">
                <button class="filter-btn active" id="activeToggle" onclick="toggleActiveFilter()">Nur Aktive</button>
            </div>
            
            <div class="divider"></div>
            
            <div class="controls">
                <select id="categoryFilter" class="category-select" onchange="handleCategoryChange()">
                    <option value="all">Alle Kategorien</option>
                </select>
            </div>
            
            <div class="divider"></div>
            
            <div class="sort-controls">
                <button class="filter-btn active" onclick="setSortMode('deadline')">Nach Deadline</button>
                <button class="filter-btn" onclick="setSortMode('category')">Nach Kategorie</button>
            </div>
        </div>

        <div class="main-layout">
            <!-- Left Sidebar -->
            <div class="left-sidebar">
                <div class="sidebar-section">
                    <button class="sidebar-button" onclick="openModal()">Neue Aufgabe</button>
                    <button class="sidebar-button" onclick="openTemplateManagerModal()">Aufgabenliste</button>
                    <button class="sidebar-button" onclick="exportData()">Exportieren</button>
                    <button class="sidebar-button" onclick="document.getElementById('importFile').click()">Importieren</button>
                </div>

                <div class="sidebar-section">
                    <div id="categorySidebar"></div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <div class="tasks-container" id="tasksContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <p>Keine Aufgaben vorhanden</p>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="right-sidebar">
                <div class="sidebar-section">
                    <button class="sidebar-button active" id="sidebarActiveToggle" onclick="toggleActiveFilter()">Nur Aktive</button>
                    <button class="sidebar-button" onclick="setSortMode('deadline')">Nach Deadline</button>
                    <button class="sidebar-button" onclick="setSortMode('category')">Nach Kategorie</button>
                </div>

                <div class="sidebar-section">
                    <div class="stat-item" onclick="filterByCompletion('open')">
                        <span class="stat-label">Offen</span>
                        <span class="stat-value" id="statOpen">0</span>
                    </div>
                    <div class="stat-item" onclick="filterByCompletion('done')">
                        <span class="stat-label">Erledigt</span>
                        <span class="stat-value" id="statDone">0</span>
                    </div>
                    <div style="margin: 15px 0; border-top: 1px solid #3d3d3d;"></div>
                    <div class="stat-item super-urgent" onclick="filterByUrgency('super-urgent')">
                        <span class="stat-label">Kritisch (≤1 Tag)</span>
                        <span class="stat-value" id="statSuperUrgent">0</span>
                    </div>
                    <div class="stat-item urgent" onclick="filterByUrgency('urgent')">
                        <span class="stat-label">Dringend (≤3 Tage)</span>
                        <span class="stat-value" id="statUrgent">0</span>
                    </div>
                    <div class="stat-item moderate" onclick="filterByUrgency('moderate')">
                        <span class="stat-label">Bald (≤7 Tage)</span>
                        <span class="stat-value" id="statModerate">0</span>
                    </div>
                    <div class="stat-item chill" onclick="filterByUrgency('chill')">
                        <span class="stat-label">Entspannt (>7 Tage)</span>
                        <span class="stat-value" id="statChill">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <h2 id="modalTitle">Neue Aufgabe</h2>
            <form id="taskForm">
                <div class="form-group">
                    <label for="taskTitle">Titel</label>
                    <input type="text" id="taskTitle" required>
                </div>

                <div class="form-group">
                    <label for="taskDescription">Beschreibung</label>
                    <textarea id="taskDescription"></textarea>
                </div>

                <div class="form-group">
                    <label for="taskCategory">Kategorie</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="taskCategory" required style="flex: 1;">
                        </select>
                        <button type="button" class="btn" onclick="openCategoryManager()" style="padding: 12px 16px;">Verwalten</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="taskDeadline">Deadline</label>
                    <input type="date" id="taskDeadline" required>
                </div>

                <div class="form-group">
                    <label for="taskDuration">Erwartete Bearbeitungszeit (Tage)</label>
                    <input type="number" id="taskDuration" min="0" step="0.5" placeholder="z.B. 2">
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="taskRepeat" onchange="toggleRepeatOptions()">
                        <span>Wiederholen</span>
                    </label>
                </div>

                <div class="form-group" id="repeatOptions" style="display: none;">
                    <label for="repeatInterval">Intervall</label>
                    <select id="repeatInterval">
                        <option value="1">Jede Woche</option>
                        <option value="2">Alle 2 Wochen</option>
                        <option value="3">Alle 3 Wochen</option>
                        <option value="4">Alle 4 Wochen</option>
                    </select>

                    <label style="margin-top: 10px;">Wochentage</label>
                    <div class="weekdays-selector">
                        <label class="weekday-checkbox"><input type="checkbox" value="1"> Mo</label>
                        <label class="weekday-checkbox"><input type="checkbox" value="2"> Di</label>
                        <label class="weekday-checkbox"><input type="checkbox" value="3"> Mi</label>
                        <label class="weekday-checkbox"><input type="checkbox" value="4"> Do</label>
                        <label class="weekday-checkbox"><input type="checkbox" value="5"> Fr</label>
                        <label class="weekday-checkbox"><input type="checkbox" value="6"> Sa</label>
                        <label class="weekday-checkbox"><input type="checkbox" value="0"> So</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Zeitraum</label>
                    <div class="time-row">
                        <div>
                            <label for="taskStartTime">Startzeit</label>
                            <input type="time" id="taskStartTime">
                        </div>
                        <div>
                            <label for="taskEndTime">Endzeit</label>
                            <input type="time" id="taskEndTime">
                        </div>
                    </div>
                </div>

                <div class="form-group" id="subtasksSection">
                    <label>Unteraufgaben</label>
                    <div id="subtasksList" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px;">
                    </div>
                    <button type="button" class="btn" onclick="addSubtaskField()" style="width: 100%;">+ Unteraufgabe hinzufügen</button>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn" onclick="closeModal()">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Category Manager Modal -->
    <div class="modal" id="categoryModal">
        <div class="modal-content">
            <h2>Kategorien verwalten</h2>
            <div class="form-group">
                <label for="newCategory">Neue Kategorie</label>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="newCategory" placeholder="Kategoriename">
                    <button class="btn btn-primary" onclick="addCategory()">Hinzufügen</button>
                </div>
            </div>
            <div class="form-group">
                <label>Bestehende Kategorien</label>
                <div id="categoryList" style="display: flex; flex-direction: column; gap: 8px;">
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeCategoryManager()">Fertig</button>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div class="modal" id="templateModal">
        <div class="modal-content">
            <h2 id="templateModalTitle">Aufgabe speichern</h2>
            <form id="templateForm">
                <div class="form-group">
                    <label for="templateName">Template-Name</label>
                    <input type="text" id="templateName" required>
                </div>

                <div class="form-group">
                    <label for="templateDescription">Beschreibung</label>
                    <textarea id="templateDescription"></textarea>
                </div>

                <div class="form-group">
                    <label for="templateCategory">Kategorie</label>
                    <select id="templateCategory" required></select>
                </div>

                <div class="form-group">
                    <label for="templateDuration">Erwartete Bearbeitungszeit (Tage)</label>
                    <input type="number" id="templateDuration" min="0" step="0.5">
                </div>

                <div class="form-group">
                    <label>Zeitraum</label>
                    <div class="time-row">
                        <div>
                            <label for="templateStartTime">Startzeit</label>
                            <input type="time" id="templateStartTime">
                        </div>
                        <div>
                            <label for="templateEndTime">Endzeit</label>
                            <input type="time" id="templateEndTime">
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Unteraufgaben</label>
                    <div id="templateSubtasksList" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 10px;"></div>
                    <button type="button" class="btn" onclick="addTemplateSubtaskField()" style="width: 100%;">+ Unteraufgabe hinzufügen</button>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn" onclick="closeTemplateModal()">Abbrechen</button>
                    <button type="submit" class="btn btn-primary">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Template Manager Modal -->
    <div class="modal" id="templateManagerModal">
        <div class="modal-content template-manager-modal">
            <div class="modal-header-with-action">
                <h2>Aufgabenliste</h2>
                <button class="btn btn-primary" onclick="openTemplateModal()">Neue Aufgabe speichern</button>
            </div>
            <div id="templateList" class="template-list-scrollable">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" onclick="closeTemplateManagerModal()">Schließen</button>
            </div>
        </div>
    </div>

    <!-- Template Load Modal (for deadline input) -->
    <div class="modal" id="templateLoadModal">
        <div class="modal-content" style="max-width: 400px;">
            <h2 id="templateLoadTitle">Aufgabe aus Template erstellen</h2>
            <div id="templateLoadContent">
                <div class="form-group">
                    <label for="templateLoadDeadline">Deadline</label>
                    <input type="date" id="templateLoadDeadline" required>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn" onclick="closeTemplateLoadModal()">Abbrechen</button>
                <button type="button" class="btn btn-primary" onclick="confirmTemplateLoad()">Erstellen</button>
            </div>
        </div>
    </div>

    <!-- Subtasks Modal -->
    <div class="modal" id="subtasksModal">
        <div class="subtasks-modal-content">
            <div class="subtasks-modal-header">
                <h3 id="subtasksModalTitle">Unteraufgaben</h3>
                <button class="modal-close-btn" onclick="closeSubtasksModal()">×</button>
            </div>
            <div id="subtasksModalList" class="subtasks-modal-list">
            </div>
        </div>
    </div>

    <script>
        let tasks = [];
        let templates = [];
        let categories = ['Arbeit', 'Privat', 'Einkaufen', 'Projekt'];
        let currentFilter = 'all';
        let sortMode = 'deadline';
        let editingTaskId = null;
        let editingTemplateId = null;
        let showOnlyActive = true;
        let openMenuId = null;
        let urgencyFilter = null;
        let currentTemplateToLoad = null;

        // Load tasks from localStorage
        function loadTasks() {
            const saved = localStorage.getItem('tasks');
            if (saved) {
                tasks = JSON.parse(saved);
                renderTasks();
            }
            const savedCategories = localStorage.getItem('categories');
            if (savedCategories) {
                categories = JSON.parse(savedCategories);
            }
            const savedTemplates = localStorage.getItem('templates');
            if (savedTemplates) {
                templates = JSON.parse(savedTemplates);
            }
            updateCategorySelect();
            updateCategorySidebar();
        }

        // Save tasks to localStorage
        function saveTasks() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }

        // Save categories to localStorage
        function saveCategories() {
            localStorage.setItem('categories', JSON.stringify(categories));
        }

        // Save templates to localStorage
        function saveTemplates() {
            localStorage.setItem('templates', JSON.stringify(templates));
        }

        // Open modal
        function openModal(taskId = null) {
            const modal = document.getElementById('taskModal');
            const form = document.getElementById('taskForm');
            const title = document.getElementById('modalTitle');

            // Clear subtasks list
            document.getElementById('subtasksList').innerHTML = '';
            subtaskCounter = 0;

            if (taskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task) {
                    title.textContent = 'Aufgabe bearbeiten';
                    document.getElementById('taskTitle').value = task.title;
                    document.getElementById('taskDescription').value = task.description || '';
                    document.getElementById('taskCategory').value = task.category;
                    document.getElementById('taskDeadline').value = task.deadline;
                    document.getElementById('taskDuration').value = task.duration || '';
                    document.getElementById('taskStartTime').value = task.startTime || '';
                    document.getElementById('taskEndTime').value = task.endTime || '';
                    
                    // Handle repeat settings
                    if (task.repeat) {
                        document.getElementById('taskRepeat').checked = true;
                        document.getElementById('repeatInterval').value = task.repeat.interval;
                        
                        // Check weekday checkboxes
                        document.querySelectorAll('.weekday-checkbox input[type="checkbox"]').forEach(cb => {
                            cb.checked = task.repeat.weekdays.includes(parseInt(cb.value));
                        });
                        
                        toggleRepeatOptions();
                    } else {
                        document.getElementById('taskRepeat').checked = false;
                        document.getElementById('repeatOptions').style.display = 'none';
                    }
                    
                    // Load existing subtasks
                    loadSubtasksToForm(taskId);
                    
                    editingTaskId = taskId;
                }
            } else {
                title.textContent = 'Neue Aufgabe';
                form.reset();
                document.getElementById('repeatOptions').style.display = 'none';
                editingTaskId = null;
            }

            modal.classList.add('active');
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('taskModal');
            modal.classList.remove('active');
            document.getElementById('taskForm').reset();
            editingTaskId = null;
        }

        // Handle form submission
        document.getElementById('taskForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const isRepeating = document.getElementById('taskRepeat').checked;
            let repeatData = null;
            
            if (isRepeating) {
                const weekdayCheckboxes = document.querySelectorAll('.weekday-checkbox input[type="checkbox"]:checked');
                const weekdays = Array.from(weekdayCheckboxes).map(cb => parseInt(cb.value));
                
                repeatData = {
                    interval: parseInt(document.getElementById('repeatInterval').value),
                    weekdays: weekdays
                };
            }

            const task = {
                id: editingTaskId || Date.now(),
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                category: document.getElementById('taskCategory').value,
                deadline: document.getElementById('taskDeadline').value,
                duration: parseFloat(document.getElementById('taskDuration').value) || 0,
                startTime: document.getElementById('taskStartTime').value,
                endTime: document.getElementById('taskEndTime').value,
                repeat: repeatData,
                completed: false,
                createdAt: editingTaskId ? tasks.find(t => t.id === editingTaskId).createdAt : new Date().toISOString()
            };

            if (editingTaskId) {
                const index = tasks.findIndex(t => t.id === editingTaskId);
                tasks[index] = task;
                
                // Remove old subtasks
                tasks = tasks.filter(t => t.parentId !== editingTaskId);
            } else {
                tasks.push(task);
            }

            // Add subtasks
            const subtaskInputs = document.querySelectorAll('.subtask-input');
            subtaskInputs.forEach(input => {
                const subtaskTitle = input.value.trim();
                if (subtaskTitle) {
                    const subtask = {
                        id: Date.now() + Math.random(),
                        title: subtaskTitle,
                        description: '',
                        category: task.category,
                        deadline: task.deadline,
                        duration: 0,
                        startTime: '',
                        endTime: '',
                        parentId: task.id,
                        repeat: null,
                        completed: false,
                        createdAt: new Date().toISOString()
                    };
                    tasks.push(subtask);
                }
            });

            saveTasks();
            renderTasks();
            updateFilters();
            updateStats();
            updateCategorySidebar();
            closeModal();
        });

        function toggleRepeatOptions() {
            const checkbox = document.getElementById('taskRepeat');
            const options = document.getElementById('repeatOptions');
            options.style.display = checkbox.checked ? 'block' : 'none';
        }

        let subtaskCounter = 0;

        function addSubtaskField(title = '') {
            const list = document.getElementById('subtasksList');
            const id = `subtask-${subtaskCounter++}`;
            
            const fieldHtml = `
                <div class="subtask-field" id="field-${id}">
                    <input type="text" class="subtask-input" placeholder="Unteraufgabe" value="${title}">
                    <button type="button" class="btn" onclick="removeSubtaskField('field-${id}')">Löschen</button>
                </div>
            `;
            
            list.insertAdjacentHTML('beforeend', fieldHtml);
        }

        function removeSubtaskField(fieldId) {
            const field = document.getElementById(fieldId);
            if (field) field.remove();
        }

        function loadSubtasksToForm(taskId) {
            const subtasks = tasks.filter(t => t.parentId === taskId);
            const list = document.getElementById('subtasksList');
            list.innerHTML = '';
            
            subtasks.forEach(subtask => {
                addSubtaskField(subtask.title);
            });
        }

        // Toggle task completion
        function toggleTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task.completed = !task.completed;
                saveTasks();
                renderTasks();
                updateStats();
                updateCategorySidebar();
                // Update subtasks modal if open
                const modal = document.getElementById('subtasksModal');
                if (modal.classList.contains('active')) {
                    const currentTaskId = modal.dataset.taskId;
                    if (currentTaskId) {
                        const parentTask = tasks.find(t => t.id == currentTaskId);
                        if (parentTask) {
                            const subtasks = tasks.filter(t => t.parentId == currentTaskId);
                            if (subtasks.some(st => st.id === taskId)) {
                                updateSubtasksModal(currentTaskId);
                            }
                        }
                    }
                }
            }
        }

        // Open subtasks modal
        function openSubtasksModal(taskId, event) {
            event.stopPropagation();
            const modal = document.getElementById('subtasksModal');
            const task = tasks.find(t => t.id === taskId);
            
            if (!task) return;
            
            modal.dataset.taskId = taskId;
            document.getElementById('subtasksModalTitle').textContent = `Unteraufgaben: ${task.title}`;
            updateSubtasksModal(taskId);
            modal.classList.add('active');
        }

        // Update subtasks modal content
        function updateSubtasksModal(taskId) {
            const subtasks = tasks.filter(t => t.parentId === taskId);
            const list = document.getElementById('subtasksModalList');
            
            if (subtasks.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #888888; padding: 20px;">Keine Unteraufgaben vorhanden</p>';
            } else {
                list.innerHTML = subtasks.map(st => createSubtaskHTML(st)).join('');
            }
        }

        // Close subtasks modal
        function closeSubtasksModal() {
            const modal = document.getElementById('subtasksModal');
            modal.classList.remove('active');
            delete modal.dataset.taskId;
        }

        // Close subtasks modal on outside click
        document.getElementById('subtasksModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSubtasksModal();
            }
        });

        // Toggle menu visibility
        function toggleMenu(taskId, event) {
            event.stopPropagation();
            const menuId = `menu-${taskId}`;
            const menu = document.getElementById(menuId);
            
            // Close other menus
            if (openMenuId && openMenuId !== menuId) {
                const oldMenu = document.getElementById(openMenuId);
                if (oldMenu) oldMenu.style.display = 'none';
            }
            
            // Toggle current menu
            if (menu.style.display === 'none' || !menu.style.display) {
                menu.style.display = 'block';
                openMenuId = menuId;
            } else {
                menu.style.display = 'none';
                openMenuId = null;
            }
        }

        // Close menu when clicking outside
        document.addEventListener('click', function(event) {
            if (openMenuId && !event.target.closest('.task-menu') && !event.target.closest('.task-menu-trigger')) {
                const menu = document.getElementById(openMenuId);
                if (menu) menu.style.display = 'none';
                openMenuId = null;
            }
        });

        // Toggle active/all filter
        function toggleActiveFilter() {
            showOnlyActive = !showOnlyActive;
            const btn = document.getElementById('activeToggle');
            if (showOnlyActive) {
                btn.classList.add('active');
                btn.textContent = 'Nur Aktive';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'Alle';
            }
            renderTasks();
        }

        // Delete task
        function deleteTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            const hasSubtasks = tasks.some(t => t.parentId === taskId);
            
            let confirmMessage = 'Möchtest du diese Aufgabe wirklich löschen?';
            if (hasSubtasks) {
                confirmMessage = 'Möchtest du diese Aufgabe und alle Unteraufgaben wirklich löschen?';
            }
            
            if (confirm(confirmMessage)) {
                // Delete the task and all its subtasks
                tasks = tasks.filter(t => t.id !== taskId && t.parentId !== taskId);
                saveTasks();
                renderTasks();
                updateFilters();
                updateStats();
                updateCategorySidebar();
            }
        }

        // Get deadline urgency
        function getDeadlineUrgency(deadline) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const deadlineDate = new Date(deadline);
            const diffTime = deadlineDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            let urgencyClass = '';
            if (diffDays < 0) urgencyClass = 'urgent';
            else if (diffDays <= 3) urgencyClass = 'soon';

            return { class: urgencyClass, date: deadlineDate.toLocaleDateString('de-DE') };
        }

        // Render tasks
        function renderTasks() {
            const container = document.getElementById('tasksContainer');
            let filteredTasks = currentFilter === 'all' 
                ? tasks 
                : tasks.filter(t => t.category === currentFilter);

            // Filter by active status
            if (showOnlyActive) {
                filteredTasks = filteredTasks.filter(t => !t.completed);
            }

            // Filter by urgency if selected
            if (urgencyFilter) {
                filteredTasks = filteredTasks.filter(t => calculateUrgency(t) === urgencyFilter);
            }

            // Exclude subtasks from main list (they'll be shown under their parents)
            filteredTasks = filteredTasks.filter(t => !t.parentId);

            if (filteredTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <p>Keine Aufgaben vorhanden</p>
                    </div>
                `;
                return;
            }

            if (sortMode === 'deadline') {
                // Sort by deadline, then show all together
                filteredTasks.sort((a, b) => {
                    if (a.completed !== b.completed) return a.completed ? 1 : -1;
                    return new Date(a.deadline) - new Date(b.deadline);
                });

                container.innerHTML = filteredTasks.map(task => createTaskHTML(task)).join('');
            } else {
                // Sort by category, but within each category sort by deadline
                const categories = [...new Set(filteredTasks.map(t => t.category))];
                
                container.innerHTML = categories.map(category => {
                    const categoryTasks = filteredTasks
                        .filter(t => t.category === category)
                        .sort((a, b) => {
                            if (a.completed !== b.completed) return a.completed ? 1 : -1;
                            return new Date(a.deadline) - new Date(b.deadline);
                        });

                    return `
                        <div class="category-section">
                            <div class="category-header">
                                <span class="category-icon"></span>
                                ${category}
                            </div>
                            <div class="tasks-grid">
                                ${categoryTasks.map(task => createTaskHTML(task)).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Create task HTML
        function createTaskHTML(task) {
            const urgency = getDeadlineUrgency(task.deadline);
            const timeInfo = task.startTime && task.endTime 
                ? `${task.startTime} - ${task.endTime}` 
                : '';
            const subtasks = tasks.filter(t => t.parentId === task.id);
            const hasSubtasks = subtasks.length > 0;
            const activeSubtasks = subtasks.filter(st => !st.completed).length;

            return `
                <div class="task-item ${task.completed ? 'completed' : ''}" data-task-id="${task.id}">
                    <div class="task-header">
                        <div class="task-content" onclick="toggleTask(${task.id})">
                            <div class="task-title">${task.title}</div>
                            <div class="task-category-label">${task.category}</div>
                            <div class="task-deadline">
                                <span class="deadline-badge ${urgency.class}">${urgency.date}</span>
                            </div>
                            ${timeInfo ? `<div class="task-time">${timeInfo}</div>` : '<div class="task-time-placeholder"></div>'}
                            ${task.description ? `<div class="task-description">${task.description}</div>` : '<div class="task-description-placeholder"></div>'}
                        </div>
                        <div class="task-menu-container">
                            ${hasSubtasks ? `
                                <div class="subtask-counter" onclick="openSubtasksModal(${task.id}, event)">
                                    ${activeSubtasks}
                                </div>
                            ` : ''}
                            <div class="task-menu-trigger" onclick="toggleMenu(${task.id}, event)">
                                <span class="menu-dots">⋯</span>
                            </div>
                        </div>
                    </div>
                    <div class="task-menu" id="menu-${task.id}" style="display: none;">
                        <button class="task-menu-btn" onclick="openModal(${task.id}); event.stopPropagation();">Bearbeiten</button>
                        <button class="task-menu-btn task-menu-delete" onclick="deleteTask(${task.id}); event.stopPropagation();">Löschen</button>
                    </div>
                </div>
            `;
        }

        // Create subtask HTML
        function createSubtaskHTML(task) {
            const urgency = getDeadlineUrgency(task.deadline);
            const timeInfo = task.startTime && task.endTime 
                ? `${task.startTime} - ${task.endTime}` 
                : '';

            return `
                <div class="subtask-item ${task.completed ? 'completed' : ''}" data-task-id="${task.id}">
                    <div class="task-header">
                        <div class="task-content" onclick="toggleTask(${task.id})">
                            <div class="task-title">${task.title}</div>
                            <div class="task-deadline">
                                <span class="deadline-badge ${urgency.class}">${urgency.date}</span>
                            </div>
                            ${timeInfo ? `<div class="task-time">${timeInfo}</div>` : '<div class="task-time-placeholder"></div>'}
                        </div>
                        <div class="task-menu-trigger" onclick="toggleMenu(${task.id}, event)">
                            <span class="menu-dots">⋯</span>
                        </div>
                    </div>
                    <div class="task-menu" id="menu-${task.id}" style="display: none;">
                        <button class="task-menu-btn" onclick="openModal(${task.id}); event.stopPropagation();">Bearbeiten</button>
                        <button class="task-menu-btn task-menu-delete" onclick="deleteTask(${task.id}); event.stopPropagation();">Löschen</button>
                    </div>
                </div>
            `;
        }

        // Filter by category
        function filterByCategory(category) {
            currentFilter = category;
            renderTasks();
        }

        // Handle category dropdown change
        function handleCategoryChange() {
            const select = document.getElementById('categoryFilter');
            currentFilter = select.value;
            renderTasks();
        }

        // Set sort mode
        function setSortMode(mode) {
            sortMode = mode;
            document.querySelectorAll('.sort-controls .filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(mode === 'deadline' ? 'Deadline' : 'Kategorie'));
            });
            renderTasks();
        }

        // Update filter dropdown
        function updateFilters() {
            const select = document.getElementById('categoryFilter');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="all">Alle Kategorien</option>' +
                categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            // Restore selection if category still exists
            if (currentValue && (currentValue === 'all' || categories.includes(currentValue))) {
                select.value = currentValue;
            } else {
                select.value = 'all';
                currentFilter = 'all';
            }
        }

        // Export data
       function exportData() {
    const data = {
        tasks: tasks,
        categories: categories,
        templates: templates
    };
    const dataStr = JSON.stringify(data, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `todo-export-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
}

        }

        // Import data
      function importData(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if (imported.tasks && Array.isArray(imported.tasks)) {
                    if (confirm('Möchtest du die importierten Daten zu den bestehenden hinzufügen oder diese ersetzen?\n\nOK = Hinzufügen\nAbbrechen = Ersetzen')) {
                        tasks = [...tasks, ...imported.tasks];
                        categories = [...new Set([...categories, ...(imported.categories || [])])];
                        templates = [...templates, ...(imported.templates || [])];
                    } else {
                        tasks = imported.tasks;
                        categories = imported.categories || [];
                        templates = imported.templates || [];
                    }
                    saveTasks();
                    saveCategories();
                    saveTemplates();
                    renderTasks();
                    updateFilters();
                    updateCategorySidebar();
                    alert('Import erfolgreich!');
                } else {
                    alert('Fehlerhafte Datei. Keine Aufgaben gefunden.');
                }
            } catch (error) {
                alert('Fehler beim Import. Bitte überprüfe die Datei.');
            }
        };
        reader.readAsText(file);
    }
    event.target.value = '';
}

        // Close modal on outside click
        document.getElementById('taskModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Category Management Functions
        function updateCategorySelect() {
            const select = document.getElementById('taskCategory');
            select.innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        function openCategoryManager() {
            const modal = document.getElementById('categoryModal');
            renderCategoryList();
            modal.classList.add('active');
        }

        function closeCategoryManager() {
            const modal = document.getElementById('categoryModal');
            modal.classList.remove('active');
            document.getElementById('newCategory').value = '';
            updateCategorySelect();
            updateFilters();
        }

        function renderCategoryList() {
            const list = document.getElementById('categoryList');
            list.innerHTML = categories.map(cat => `
                <div class="category-item">
                    <span class="category-item-name">${cat}</span>
                    <div class="category-item-actions">
                        <button class="task-btn" onclick="editCategory('${cat}')">Umbenennen</button>
                        <button class="task-btn task-btn-delete" onclick="deleteCategory('${cat}')">Löschen</button>
                    </div>
                </div>
            `).join('');
        }

        function addCategory() {
            const input = document.getElementById('newCategory');
            const newCat = input.value.trim();
            if (newCat && !categories.includes(newCat)) {
                categories.push(newCat);
                saveCategories();
                renderCategoryList();
                input.value = '';
            } else if (categories.includes(newCat)) {
                alert('Diese Kategorie existiert bereits!');
            }
        }

        function editCategory(oldName) {
            const newName = prompt('Neuer Name für die Kategorie:', oldName);
            if (newName && newName.trim() && newName !== oldName) {
                const trimmedName = newName.trim();
                if (categories.includes(trimmedName)) {
                    alert('Diese Kategorie existiert bereits!');
                    return;
                }
                const index = categories.indexOf(oldName);
                if (index > -1) {
                    categories[index] = trimmedName;
                    // Update all tasks with this category
                    tasks.forEach(task => {
                        if (task.category === oldName) {
                            task.category = trimmedName;
                        }
                    });
                    saveTasks();
                    saveCategories();
                    renderCategoryList();
                    renderTasks();
                }
            }
        }

        function deleteCategory(catName) {
            if (confirm(`Möchtest du die Kategorie "${catName}" wirklich löschen?\n\nAlle Aufgaben dieser Kategorie werden ebenfalls gelöscht.`)) {
                categories = categories.filter(c => c !== catName);
                tasks = tasks.filter(t => t.category !== catName);
                saveTasks();
                saveCategories();
                renderCategoryList();
                renderTasks();
                updateFilters();
            }
        }

        // Close category modal on outside click
        document.getElementById('categoryModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCategoryManager();
            }
        });

        // Filter by completion status
        function filterByCompletion(status) {
            if (status === 'open') {
                showOnlyActive = true;
                document.getElementById('activeToggle').classList.add('active');
                document.getElementById('activeToggle').textContent = 'Nur Aktive';
            } else {
                showOnlyActive = false;
                document.getElementById('activeToggle').classList.remove('active');
                document.getElementById('activeToggle').textContent = 'Alle';
            }
            urgencyFilter = null;
            currentFilter = 'all';
            
            document.querySelectorAll('.stat-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            renderTasks();
        }

        // Template Modal Functions
        let templateSubtaskCounter = 0;

        function openTemplateModal(templateId = null) {
            const modal = document.getElementById('templateModal');
            const form = document.getElementById('templateForm');
            const title = document.getElementById('templateModalTitle');
            
            // Populate category select
            document.getElementById('templateCategory').innerHTML = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            document.getElementById('templateSubtasksList').innerHTML = '';
            templateSubtaskCounter = 0;
            
            if (templateId) {
                const template = templates.find(t => t.id === templateId);
                if (template) {
                    title.textContent = 'Aufgabe bearbeiten';
                    document.getElementById('templateName').value = template.name;
                    document.getElementById('templateDescription').value = template.description || '';
                    document.getElementById('templateCategory').value = template.category;
                    document.getElementById('templateDuration').value = template.duration || '';
                    document.getElementById('templateStartTime').value = template.startTime || '';
                    document.getElementById('templateEndTime').value = template.endTime || '';
                    
                    if (template.subtasks) {
                        template.subtasks.forEach(st => addTemplateSubtaskField(st));
                    }
                    
                    editingTemplateId = templateId;
                }
            } else {
                title.textContent = 'Aufgabe speichern';
                form.reset();
                editingTemplateId = null;
            }
            
            // Close template manager if open
            document.getElementById('templateManagerModal').classList.remove('active');
            
            modal.classList.add('active');
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
            document.getElementById('templateForm').reset();
            editingTemplateId = null;
            
            // Reopen template manager if it was open
            if (document.getElementById('templateManagerModal').dataset.wasOpen === 'true') {
                openTemplateManagerModal();
                delete document.getElementById('templateManagerModal').dataset.wasOpen;
            }
        }

        function addTemplateSubtaskField(title = '') {
            const list = document.getElementById('templateSubtasksList');
            const id = `template-subtask-${templateSubtaskCounter++}`;
            
            const fieldHtml = `
                <div class="subtask-field" id="field-${id}">
                    <input type="text" class="template-subtask-input" placeholder="Unteraufgabe" value="${title}">
                    <button type="button" class="btn" onclick="document.getElementById('field-${id}').remove()">Löschen</button>
                </div>
            `;
            
            list.insertAdjacentHTML('beforeend', fieldHtml);
        }

        // Handle template form submission
        document.getElementById('templateForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const subtaskInputs = document.querySelectorAll('.template-subtask-input');
            const subtasks = [];
            subtaskInputs.forEach(input => {
                const subtaskTitle = input.value.trim();
                if (subtaskTitle) {
                    subtasks.push(subtaskTitle);
                }
            });
            
            const template = {
                id: editingTemplateId || Date.now(),
                name: document.getElementById('templateName').value,
                description: document.getElementById('templateDescription').value,
                category: document.getElementById('templateCategory').value,
                duration: parseFloat(document.getElementById('templateDuration').value) || 0,
                startTime: document.getElementById('templateStartTime').value,
                endTime: document.getElementById('templateEndTime').value,
                subtasks: subtasks,
                createdAt: editingTemplateId ? templates.find(t => t.id === editingTemplateId).createdAt : new Date().toISOString()
            };
            
            if (editingTemplateId) {
                const index = templates.findIndex(t => t.id === editingTemplateId);
                templates[index] = template;
            } else {
                templates.push(template);
            }
            
            saveTemplates();
            
            // Mark that template manager should reopen
            document.getElementById('templateManagerModal').dataset.wasOpen = 'true';
            
            closeTemplateModal();
        });

        // Template Manager Modal
        function openTemplateManagerModal() {
            const modal = document.getElementById('templateManagerModal');
            renderTemplateList();
            modal.classList.add('active');
        }

        function closeTemplateManagerModal() {
            document.getElementById('templateManagerModal').classList.remove('active');
        }

        function renderTemplateList() {
            const list = document.getElementById('templateList');
            
            if (templates.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #888888; padding: 20px;">Keine gespeicherten Aufgaben vorhanden</p>';
                return;
            }
            
            list.innerHTML = templates.map(template => `
                <div class="template-item" data-template-id="${template.id}">
                    <div class="template-item-header">
                        <div style="flex: 1; cursor: pointer;" onclick="loadTemplate(${template.id})">
                            <div class="template-item-title">${template.name}</div>
                            ${template.description ? `<div class="template-item-description">${template.description}</div>` : ''}
                            <div class="template-item-meta">
                                Kategorie: ${template.category} | 
                                ${template.subtasks && template.subtasks.length > 0 ? `${template.subtasks.length} Unteraufgaben` : 'Keine Unteraufgaben'}
                            </div>
                        </div>
                        <div class="task-menu-trigger" onclick="toggleTemplateMenu(${template.id}, event)">
                            <span class="menu-dots">⋯</span>
                        </div>
                    </div>
                    <div class="task-menu" id="template-menu-${template.id}" style="display: none;">
                        <button class="task-menu-btn" onclick="openTemplateModal(${template.id}); event.stopPropagation();">Bearbeiten</button>
                        <button class="task-menu-btn task-menu-delete" onclick="deleteTemplate(${template.id}); event.stopPropagation();">Löschen</button>
                    </div>
                </div>
            `).join('');
        }

        let openTemplateMenuId = null;

        function toggleTemplateMenu(templateId, event) {
            event.stopPropagation();
            const menuId = `template-menu-${templateId}`;
            const menu = document.getElementById(menuId);
            
            // Close other menus
            if (openTemplateMenuId && openTemplateMenuId !== menuId) {
                const oldMenu = document.getElementById(openTemplateMenuId);
                if (oldMenu) oldMenu.style.display = 'none';
            }
            
            // Toggle current menu
            if (menu.style.display === 'none' || !menu.style.display) {
                menu.style.display = 'block';
                openTemplateMenuId = menuId;
            } else {
                menu.style.display = 'none';
                openTemplateMenuId = null;
            }
        }

        // Close template menu when clicking outside
        document.addEventListener('click', function(event) {
            if (openTemplateMenuId && !event.target.closest('.task-menu') && !event.target.closest('.task-menu-trigger')) {
                const menu = document.getElementById(openTemplateMenuId);
                if (menu) menu.style.display = 'none';
                openTemplateMenuId = null;
            }
        });

        function deleteTemplate(templateId) {
            if (confirm('Möchtest du diese gespeicherte Aufgabe wirklich löschen?')) {
                templates = templates.filter(t => t.id !== templateId);
                saveTemplates();
                renderTemplateList();
            }
        }

        // Load Template
        function loadTemplate(templateId) {
            currentTemplateToLoad = templates.find(t => t.id === templateId);
            if (!currentTemplateToLoad) return;
            
            document.getElementById('templateLoadTitle').textContent = `Aufgabe erstellen: ${currentTemplateToLoad.name}`;
            document.getElementById('templateLoadModal').classList.add('active');
        }

        function closeTemplateLoadModal() {
            document.getElementById('templateLoadModal').classList.remove('active');
            currentTemplateToLoad = null;
        }

        function confirmTemplateLoad() {
            if (!currentTemplateToLoad) return;
            
            const deadline = document.getElementById('templateLoadDeadline').value;
            if (!deadline) {
                alert('Bitte eine Deadline auswählen');
                return;
            }
            
            // Create main task from template
            const taskId = Date.now();
            const task = {
                id: taskId,
                title: currentTemplateToLoad.name,
                description: currentTemplateToLoad.description || '',
                category: currentTemplateToLoad.category,
                deadline: deadline,
                duration: currentTemplateToLoad.duration || 0,
                startTime: currentTemplateToLoad.startTime || '',
                endTime: currentTemplateToLoad.endTime || '',
                repeat: null,
                completed: false,
                createdAt: new Date().toISOString()
            };
            
            tasks.push(task);
            
            // Create subtasks if any
            if (currentTemplateToLoad.subtasks && currentTemplateToLoad.subtasks.length > 0) {
                currentTemplateToLoad.subtasks.forEach(subtaskTitle => {
                    const subtask = {
                        id: Date.now() + Math.random(),
                        title: subtaskTitle,
                        description: '',
                        category: task.category,
                        deadline: task.deadline,
                        duration: 0,
                        startTime: '',
                        endTime: '',
                        parentId: taskId,
                        repeat: null,
                        completed: false,
                        createdAt: new Date().toISOString()
                    };
                    tasks.push(subtask);
                });
            }
            
            saveTasks();
            renderTasks();
            updateStats();
            updateCategorySidebar();
            closeTemplateLoadModal();
            closeTemplateManagerModal();
        }

        // Close modals on outside click
        document.getElementById('templateModal').addEventListener('click', function(e) {
            if (e.target === this) closeTemplateModal();
        });
        
        document.getElementById('templateManagerModal').addEventListener('click', function(e) {
            if (e.target === this) closeTemplateManagerModal();
        });
        
        document.getElementById('templateLoadModal').addEventListener('click', function(e) {
            if (e.target === this) closeTemplateLoadModal();
        });

        // Initialize
        loadTasks();
        updateFilters();
        updateStats();

        // Calculate urgency based on duration and deadline
        function calculateUrgency(task) {
            if (!task.duration || task.duration === 0) {
                // Fallback to deadline-only logic
                const deadline = new Date(task.deadline);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const daysUntil = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
                
                if (daysUntil <= 1) return 'super-urgent';
                if (daysUntil <= 3) return 'urgent';
                if (daysUntil <= 7) return 'moderate';
                return 'chill';
            }
            
            // Calculate time buffer (days until deadline - expected duration)
            const deadline = new Date(task.deadline);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const daysUntil = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
            const buffer = daysUntil - task.duration;
            
            if (buffer <= 1) return 'super-urgent';
            if (buffer <= 3) return 'urgent';
            if (buffer <= 7) return 'moderate';
            return 'chill';
        }

        // Update stats
        function updateStats() {
            const openTasks = tasks.filter(t => !t.completed && !t.parentId).length;
            const completedTasks = tasks.filter(t => t.completed && !t.parentId).length;
            
            const activeTasks = tasks.filter(t => !t.completed && !t.parentId);
            const superUrgent = activeTasks.filter(t => calculateUrgency(t) === 'super-urgent').length;
            const urgent = activeTasks.filter(t => calculateUrgency(t) === 'urgent').length;
            const moderate = activeTasks.filter(t => calculateUrgency(t) === 'moderate').length;
            const chill = activeTasks.filter(t => calculateUrgency(t) === 'chill').length;
            
            document.getElementById('statTotal').textContent = `${openTasks} / ${completedTasks}`;
            document.getElementById('statSuperUrgent').textContent = superUrgent;
            document.getElementById('statUrgent').textContent = urgent;
            document.getElementById('statModerate').textContent = moderate;
            document.getElementById('statChill').textContent = chill;
        }

        // Update category sidebar
        function updateCategorySidebar() {
            const sidebar = document.getElementById('categorySidebar');
            if (!sidebar) return;
            
            sidebar.innerHTML = `
                <div class="category-list-item ${currentFilter === 'all' ? 'active' : ''}" onclick="filterByCategorySidebar('all')">
                    <span>Alle Kategorien</span>
                    <span>${tasks.filter(t => !t.parentId).length}</span>
                </div>
            ` + categories.map(cat => {
                const count = tasks.filter(t => t.category === cat && !t.parentId).length;
                return `
                    <div class="category-list-item ${currentFilter === cat ? 'active' : ''}" onclick="filterByCategorySidebar('${cat}')">
                        <span>${cat}</span>
                        <span>${count}</span>
                    </div>
                `;
            }).join('');
        }

        // Filter by category from sidebar
        function filterByCategorySidebar(category) {
            currentFilter = category;
            urgencyFilter = null;
            
            // Update category filter select
            const select = document.getElementById('categoryFilter');
            if (select) select.value = category;
            
            // Update sidebar active states
            document.querySelectorAll('.category-list-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.stat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            renderTasks();
            updateCategorySidebar();
        }

        // Filter by urgency
        function filterByUrgency(urgency) {
            urgencyFilter = urgency === 'all' ? null : urgency;
            currentFilter = 'all';
            
            // Update select
            const select = document.getElementById('categoryFilter');
            if (select) select.value = 'all';
            
            // Update sidebar active states
            document.querySelectorAll('.stat-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.category-list-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (urgency !== 'all') {
                event.currentTarget.classList.add('active');
            }
            
            renderTasks();
            updateCategorySidebar();
        }
    </script>
</body>
</html>
