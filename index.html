<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #2d2d2d 0%, #1a1a1a 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            position: relative;
        }

        /* Login Screen */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: linear-gradient(135deg, #3d3d3d 0%, #2d2d2d 100%);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 320px;
            width: 100%;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            margin: 8px 0;
            border: none;
            border-radius: 15px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .google-btn {
            background: white;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .offline-btn {
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
        }

        .divider {
            margin: 20px 0;
            color: #888;
            font-size: 0.85em;
        }

        /* Main App */
        .app-container {
            display: none;
        }

        .app-container.active {
            display: block;
        }

        /* Account Bubble */
        .account-bubble {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3d3d3d 0%, #2d2d2d 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
            color: #ff8c42;
            font-weight: 500;
            font-size: 1.1em;
        }

        .account-bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }

        .account-bubble.offline {
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
        }

        .account-bubble img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Dropdown Menu */
        .dropdown-menu {
            position: fixed;
            top: 75px;
            right: 20px;
            background: linear-gradient(135deg, #3d3d3d 0%, #2d2d2d 100%);
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            padding: 10px;
            min-width: 200px;
            display: none;
            z-index: 99;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #e0e0e0;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dropdown-item:hover {
            background: linear-gradient(135deg, #4d4d4d 0%, #3d3d3d 100%);
        }

        .dropdown-divider {
            height: 1px;
            background: rgba(255, 107, 53, 0.2);
            margin: 5px 0;
        }

        .nav {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: linear-gradient(135deg, #3d3d3d 0%, #2d2d2d 100%);
            color: #e0e0e0;
            border: none;
            padding: 10px 20px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.4);
        }

        .controls {
            background: linear-gradient(135deg, #3d3d3d 0%, #333333 100%);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .sort-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            flex: 1;
        }

        .sort-btn {
            background: linear-gradient(135deg, #4d4d4d 0%, #3d3d3d 100%);
            color: #e0e0e0;
            border: none;
            padding: 8px 14px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .sort-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .sort-btn.active {
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
        }

        .add-btn {
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 107, 53, 0.4);
        }

        .content-area {
            min-height: 400px;
        }

        .project-card {
            background: linear-gradient(135deg, #3d3d3d 0%, #333333 100%);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .project-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .project-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .project-main {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            cursor: pointer;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #ff6b35;
            flex-shrink: 0;
        }

        .project-name {
            font-size: 1.1em;
            font-weight: 500;
            color: #ff8c42;
            cursor: pointer;
        }

        .project-name:hover {
            text-decoration: underline;
        }

        .task-counter {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            color: #b0b0b0;
        }

        .counter-badge {
            background: rgba(255, 107, 53, 0.2);
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 500;
        }

        .counter-urgent {
            background: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }

        .project-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .toggle-btn {
            background: linear-gradient(135deg, #4d4d4d 0%, #3d3d3d 100%);
            color: #e0e0e0;
            border: none;
            padding: 6px 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .toggle-btn:hover {
            background: linear-gradient(135deg, #5d5d5d 0%, #4d4d4d 100%);
        }

        .add-task-btn {
            background: linear-gradient(135deg, #4d6f4d 0%, #3d5f3d 100%);
            color: #b0ffb0;
            border: none;
            padding: 6px 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .add-task-btn:hover {
            background: linear-gradient(135deg, #5d7f5d 0%, #4d6f4d 100%);
            transform: translateY(-2px);
        }

        .delete-btn {
            background: linear-gradient(135deg, #6d3d3d 0%, #5d2d2d 100%);
            color: #ffb0b0;
            border: none;
            padding: 6px 10px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .delete-btn:hover {
            background: linear-gradient(135deg, #7d4d4d 0%, #6d3d3d 100%);
            transform: translateY(-2px);
        }

        .task-list {
            margin-top: 12px;
            display: none;
        }

        .task-list.expanded {
            display: block;
        }

        .task-item {
            background: linear-gradient(135deg, #4d4d4d 0%, #3d3d3d 100%);
            padding: 10px 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .task-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .task-item.completed {
            opacity: 0.5;
        }

        .subtask-item {
            background: linear-gradient(135deg, #5d5d5d 0%, #4d4d4d 100%);
            padding: 8px 10px;
            border-radius: 10px;
            margin-bottom: 6px;
            margin-left: 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .subtask-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .subtask-item.completed {
            opacity: 0.5;
        }

        .task-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .task-name {
            color: #e0e0e0;
            font-size: 0.95em;
            cursor: pointer;
        }

        .task-name:hover {
            text-decoration: underline;
        }

        .task-name.completed {
            text-decoration: line-through;
            color: #888;
        }

        .task-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .deadline {
            font-size: 0.8em;
            color: #b0b0b0;
            background: rgba(255, 107, 53, 0.1);
            padding: 3px 8px;
            border-radius: 8px;
        }

        .deadline.overdue {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.2);
        }

        .deadline.urgent {
            color: #ff8c42;
            background: rgba(255, 140, 66, 0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, #3d3d3d 0%, #2d2d2d 100%);
            padding: 25px;
            border-radius: 20px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #ff8c42;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #b0b0b0;
            font-size: 0.85em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #4d4d4d;
            border-radius: 12px;
            font-size: 0.95em;
            background: #2d2d2d;
            color: #e0e0e0;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 15px rgba(255, 107, 53, 0.3);
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-cancel {
            background: linear-gradient(135deg, #4d4d4d 0%, #3d3d3d 100%);
            color: #e0e0e0;
            border: none;
            padding: 10px 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-save {
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover,
        .btn-save:hover {
            transform: translateY(-2px);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        @media (max-width: 768px) {
            .project-header {
                flex-wrap: wrap;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .sort-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <button class="login-btn google-btn" onclick="loginWithGoogle()">
                <svg width="20" height="20" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Mit Google anmelden
            </button>
            <div class="divider">oder</div>
            <button class="login-btn offline-btn" onclick="loginOffline()">
                Offline fortfahren
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <!-- Account Bubble -->
        <div class="account-bubble" id="accountBubble" onclick="toggleDropdown()">
            <span id="accountInitial">O</span>
        </div>

        <!-- Dropdown Menu -->
        <div class="dropdown-menu" id="dropdownMenu">
            <div class="dropdown-item" onclick="createBackup()">💾 Backup erstellen</div>
            <div class="dropdown-item" onclick="loadBackup()">📂 Backup laden</div>
            <div class="dropdown-divider"></div>
            <div class="dropdown-item" onclick="logout()">🚪 Abmelden</div>
        </div>

        <div class="container">
            <div class="nav">
                <button class="nav-btn active" onclick="showView('today')">Heute</button>
                <button class="nav-btn" onclick="showView('all')">Alle</button>
            </div>

            <div class="controls">
                <div class="sort-controls">
                    <button class="sort-btn active" onclick="setSortMode('default')">Standard</button>
                    <button class="sort-btn" onclick="setSortMode('project-deadline')">Projekte nach Deadline</button>
                    <button class="sort-btn" onclick="setSortMode('task-deadline')">Aufgaben nach Deadline</button>
                </div>
                <button class="add-btn" onclick="openProjectModal()">+ Projekt</button>
                <button class="add-btn" onclick="openTaskModal()">+ Aufgabe</button>
            </div>

            <div class="content-area" id="contentArea">
                <!-- Dynamischer Inhalt -->
            </div>
        </div>
    </div>

    <!-- Projekt Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <h2 class="modal-header" id="projectModalTitle">Neues Projekt</h2>
            <form id="projectForm">
                <input type="hidden" id="projectId">
                <div class="form-group">
                    <label for="projectName">Projektname</label>
                    <input type="text" id="projectName" required>
                </div>
                <div class="form-group">
                    <label for="projectDescription">Beschreibung (optional)</label>
                    <textarea id="projectDescription"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeProjectModal()">Abbrechen</button>
                    <button type="submit" class="btn-save">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Aufgaben Modal -->
    <div class="modal" id="taskModal">
        <div class="modal-content">
            <h2 class="modal-header" id="taskModalTitle">Neue Aufgabe</h2>
            <form id="taskForm">
                <input type="hidden" id="taskId">
                <input type="hidden" id="taskProjectId">
                <div class="form-group">
                    <label for="taskName">Aufgabenname</label>
                    <input type="text" id="taskName" required>
                </div>
                <div class="form-group">
                    <label for="taskDescription">Beschreibung (optional)</label>
                    <textarea id="taskDescription"></textarea>
                </div>
                <div class="form-group" id="taskProjectGroup">
                    <label for="taskProject">Projekt</label>
                    <select id="taskProject" required>
                        <option value="">Projekt wählen...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskDeadline">Deadline (optional)</label>
                    <input type="datetime-local" id="taskDeadline">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeTaskModal()">Abbrechen</button>
                    <button type="submit" class="btn-save">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Unteraufgaben Modal -->
    <div class="modal" id="subtaskModal">
        <div class="modal-content">
            <h2 class="modal-header" id="subtaskModalTitle">Neue Unteraufgabe</h2>
            <form id="subtaskForm">
                <input type="hidden" id="subtaskId">
                <input type="hidden" id="subtaskParentId">
                <div class="form-group">
                    <label for="subtaskName">Unteraufgabenname</label>
                    <input type="text" id="subtaskName" required>
                </div>
                <div class="form-group">
                    <label for="subtaskDescription">Beschreibung (optional)</label>
                    <textarea id="subtaskDescription"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeSubtaskModal()">Abbrechen</button>
                    <button type="submit" class="btn-save">Speichern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hidden File Input für Backup -->
    <input type="file" id="backupFileInput" accept=".json" style="display: none;" onchange="handleBackupFile(event)">

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        // Globale Variablen
        let projects = [];
        let tasks = [];
        let subtasks = [];
        let currentView = 'today';
        let currentSort = 'default';
        let currentUser = null;
        let collapsedProjects = new Set();

        // ⚠️ WICHTIG: Ersetze diese Client ID mit deiner eigenen!
        // So bekommst du eine Client ID:
        // 1. Gehe zu https://console.cloud.google.com/
        // 2. Erstelle ein Projekt
        // 3. Aktiviere "Google+ API"
        // 4. Gehe zu "Credentials" → "Create Credentials" → "OAuth client ID"
        // 5. Wähle "Web application"
        // 6. Füge deine URL als "Authorized JavaScript origins" hinzu
        // 7. Kopiere die Client ID hierhin:
        const GOOGLE_CLIENT_ID = '142758524013-aspsuv7beskpbci2ab3v246o5evivvcd.apps.googleusercontent.com'; // ← Hier deine Client ID einfügen!

        // Initialisierung
        function init() {
            checkAuth();
        }

        function checkAuth() {
            const user = localStorage.getItem('currentUser');
            if (user) {
                currentUser = JSON.parse(user);
                loadUserData();
                showApp();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').classList.remove('active');
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
            updateAccountBubble();
            showView('today');
        }

        function updateAccountBubble() {
            const bubble = document.getElementById('accountBubble');
            const initial = document.getElementById('accountInitial');
            
            if (currentUser.mode === 'offline') {
                bubble.classList.add('offline');
                initial.textContent = 'O';
            } else {
                bubble.classList.remove('offline');
                if (currentUser.photo) {
                    initial.innerHTML = `<img src="${currentUser.photo}" alt="${currentUser.name}">`;
                } else {
                    initial.textContent = currentUser.name.charAt(0).toUpperCase();
                }
            }
        }

        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
        }

        // Click außerhalb schließt Dropdown
        document.addEventListener('click', function(e) {
            const bubble = document.getElementById('accountBubble');
            const dropdown = document.getElementById('dropdownMenu');
            if (!bubble.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        function loginWithGoogle() {
            // Prüfe ob Client ID konfiguriert wurde
            if (GOOGLE_CLIENT_ID === '142758524013-aspsuv7beskpbci2ab3v246o5evivvcd.apps.googleusercontent.com') {
                alert('⚠️ Google Login nicht konfiguriert!\n\nBitte ersetze die GOOGLE_CLIENT_ID im Code mit deiner eigenen Client ID.\n\nAnleitung:\n1. Öffne die HTML-Datei in einem Editor\n2. Suche nach "GOOGLE_CLIENT_ID"\n3. Ersetze den Wert mit deiner Client ID von console.cloud.google.com');
                return;
            }
            
            // Prüfe ob Google API geladen wurde
            if (typeof google === 'undefined' || !google.accounts) {
                alert('⚠️ Google API konnte nicht geladen werden.\n\nBitte stelle sicher, dass du eine Internetverbindung hast.');
                return;
            }
            
            // Initialisiere Google Sign-In
            google.accounts.id.initialize({
                client_id: GOOGLE_CLIENT_ID,
                callback: handleGoogleCallback
            });
            
            // Zeige das Google Sign-In Popup
            google.accounts.id.prompt();
        }

        function handleGoogleCallback(response) {
            // Dekodiere das JWT Token
            const credential = response.credential;
            const payload = parseJwt(credential);
            
            // Erstelle User Object
            currentUser = {
                name: payload.name,
                email: payload.email,
                photo: payload.picture,
                mode: 'google'
            };
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            loadUserData();
            showApp();
        }

        function parseJwt(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        function loginOffline() {
            currentUser = { name: 'Offline User', mode: 'offline' };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            loadUserData();
            showApp();
        }

        function logout() {
            document.getElementById('dropdownMenu').classList.remove('show');
            if (confirm('Wirklich abmelden?')) {
                saveData();
                localStorage.removeItem('currentUser');
                currentUser = null;
                showLogin();
            }
        }

        // Backup-Funktionen
        function createBackup() {
            document.getElementById('dropdownMenu').classList.remove('show');
            const backup = {
                version: '1.0',
                date: new Date().toISOString(),
                projects: projects,
                tasks: tasks,
                subtasks: subtasks
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function loadBackup() {
            document.getElementById('dropdownMenu').classList.remove('show');
            document.getElementById('backupFileInput').click();
        }

        function handleBackupFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    if (backup.projects && backup.tasks) {
                        if (confirm('Backup laden? Dies überschreibt alle aktuellen Daten.')) {
                            projects = backup.projects;
                            tasks = backup.tasks;
                            subtasks = backup.subtasks || [];
                            saveData();
                            renderContent();
                            alert('Backup erfolgreich geladen!');
                        }
                    } else {
                        alert('Ungültiges Backup-Format!');
                    }
                } catch (error) {
                    alert('Fehler beim Laden des Backups!');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Daten laden/speichern
        function loadUserData() {
            const storageKey = currentUser.mode === 'google' ? `projects_${currentUser.email}` : 'projects';
            const tasksKey = currentUser.mode === 'google' ? `tasks_${currentUser.email}` : 'tasks';
            const subtasksKey = currentUser.mode === 'google' ? `subtasks_${currentUser.email}` : 'subtasks';
            
            projects = JSON.parse(localStorage.getItem(storageKey)) || [];
            tasks = JSON.parse(localStorage.getItem(tasksKey)) || [];
            subtasks = JSON.parse(localStorage.getItem(subtasksKey)) || [];
        }

        function saveData() {
            const storageKey = currentUser.mode === 'google' ? `projects_${currentUser.email}` : 'projects';
            const tasksKey = currentUser.mode === 'google' ? `tasks_${currentUser.email}` : 'tasks';
            const subtasksKey = currentUser.mode === 'google' ? `subtasks_${currentUser.email}` : 'subtasks';
            
            localStorage.setItem(storageKey, JSON.stringify(projects));
            localStorage.setItem(tasksKey, JSON.stringify(tasks));
            localStorage.setItem(subtasksKey, JSON.stringify(subtasks));
        }

        // Views
        function showView(view) {
            currentView = view;
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderContent();
        }

        // Sortierung
        function setSortMode(mode) {
            currentSort = mode;
            document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderContent();
        }

        // Hauptrender-Funktion
        function renderContent() {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = '';

            let filteredProjects = [...projects];
            
            if (currentView === 'today') {
                const today = new Date().toISOString().split('T')[0];
                filteredProjects = projects.filter(p => {
                    const projectTasks = getProjectTasks(p.id);
                    return projectTasks.some(t => t.deadline && t.deadline.startsWith(today));
                });
            }

            if (filteredProjects.length === 0) {
                contentArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <p>Keine Projekte gefunden</p>
                    </div>
                `;
                return;
            }

            // Sortierung nach Projekt-Deadline
            if (currentSort === 'project-deadline') {
                filteredProjects.sort((a, b) => {
                    const aEarliestDeadline = getEarliestTaskDeadline(a.id);
                    const bEarliestDeadline = getEarliestTaskDeadline(b.id);
                    
                    if (!aEarliestDeadline) return 1;
                    if (!bEarliestDeadline) return -1;
                    return new Date(aEarliestDeadline) - new Date(bEarliestDeadline);
                });
            }

            if (currentSort === 'task-deadline') {
                renderTasksOnly(filteredProjects);
                return;
            }

            filteredProjects.forEach(project => {
                renderProject(project);
            });
        }

        function getEarliestTaskDeadline(projectId) {
            const projectTasks = getProjectTasks(projectId).filter(t => t.deadline);
            if (projectTasks.length === 0) return null;
            
            const sorted = projectTasks.sort((a, b) => new Date(a.deadline) - new Date(b.deadline));
            return sorted[0].deadline;
        }

        function renderProject(project) {
            const contentArea = document.getElementById('contentArea');
            const projectTasks = getProjectTasks(project.id);
            const openTasks = projectTasks.filter(t => !t.completed).length;
            const urgentTasks = projectTasks.filter(t => !t.completed && isUrgent(t.deadline)).length;
            const isCollapsed = collapsedProjects.has(project.id);
            
            const projectCard = document.createElement('div');
            projectCard.className = 'project-card';
            projectCard.innerHTML = `
                <div class="project-header">
                    <div class="project-main" onclick="toggleProject(${project.id})">
                        <span class="project-name" onclick="editProject(${project.id}); event.stopPropagation();">${project.name}</span>
                        <div class="task-counter">
                            <span class="counter-badge">${openTasks}</span>
                            ${urgentTasks > 0 ? `<span class="counter-badge counter-urgent">${urgentTasks}</span>` : ''}
                        </div>
                    </div>
                    <div class="project-actions">
                        <button class="toggle-btn" onclick="toggleProject(${project.id}); event.stopPropagation();">
                            ${isCollapsed ? '▼' : '▲'}
                        </button>
                        <button class="add-task-btn" onclick="addTaskToProject(${project.id}); event.stopPropagation();">+</button>
                        <button class="delete-btn" onclick="deleteProject(${project.id}); event.stopPropagation();">−</button>
                    </div>
                </div>
                <div class="task-list ${isCollapsed ? '' : 'expanded'}" id="taskList${project.id}"></div>
            `;
            
            contentArea.appendChild(projectCard);
            renderTasks(project.id);
        }

        function toggleProject(projectId) {
            if (collapsedProjects.has(projectId)) {
                collapsedProjects.delete(projectId);
            } else {
                collapsedProjects.add(projectId);
            }
            renderContent();
        }

        function renderTasks(projectId) {
            const taskList = document.getElementById(`taskList${projectId}`);
            let projectTasks = getProjectTasks(projectId);
            
            projectTasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = `task-item ${task.completed ? 'completed' : ''}`;
                taskItem.innerHTML = `
                    <div class="task-info">
                        <input type="checkbox" class="checkbox" ${task.completed ? 'checked' : ''} 
                            onchange="toggleTask(${task.id})">
                        <span class="task-name ${task.completed ? 'completed' : ''}" onclick="editTask(${task.id})">${task.name}</span>
                        ${task.deadline ? `<span class="deadline ${isOverdue(task.deadline) ? 'overdue' : isUrgent(task.deadline) ? 'urgent' : ''}">${formatDeadline(task.deadline)}</span>` : ''}
                    </div>
                    <div class="task-actions">
                        <button class="add-task-btn" onclick="addSubtaskToTask(${task.id}); event.stopPropagation();">+</button>
                        <button class="delete-btn" onclick="deleteTask(${task.id})">−</button>
                    </div>
                `;
                taskList.appendChild(taskItem);
                
                // Render Subtasks
                renderSubtasks(task.id, taskList);
            });
        }

        function renderSubtasks(taskId, parentElement) {
            const taskSubtasks = getTaskSubtasks(taskId);
            const parentTask = tasks.find(t => t.id === taskId);
            
            taskSubtasks.forEach(subtask => {
                const subtaskItem = document.createElement('div');
                subtaskItem.className = `subtask-item ${subtask.completed ? 'completed' : ''}`;
                subtaskItem.innerHTML = `
                    <div class="task-info">
                        <input type="checkbox" class="checkbox" ${subtask.completed ? 'checked' : ''} 
                            onchange="toggleSubtask(${subtask.id})">
                        <span class="task-name ${subtask.completed ? 'completed' : ''}" onclick="editSubtask(${subtask.id})">${subtask.name}</span>
                        ${parentTask.deadline ? `<span class="deadline ${isOverdue(parentTask.deadline) ? 'overdue' : isUrgent(parentTask.deadline) ? 'urgent' : ''}">${formatDeadline(parentTask.deadline)}</span>` : ''}
                    </div>
                    <button class="delete-btn" onclick="deleteSubtask(${subtask.id})">−</button>
                `;
                parentElement.appendChild(subtaskItem);
            });
        }

        function renderTasksOnly(filteredProjects) {
            const contentArea = document.getElementById('contentArea');
            let allTasks = [];
            
            filteredProjects.forEach(project => {
                const projectTasks = getProjectTasks(project.id);
                projectTasks.forEach(task => {
                    allTasks.push({ ...task, projectName: project.name });
                });
            });

            allTasks.sort((a, b) => {
                if (!a.deadline) return 1;
                if (!b.deadline) return -1;
                return new Date(a.deadline) - new Date(b.deadline);
            });

            if (allTasks.length === 0) {
                contentArea.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✓</div>
                        <p>Keine Aufgaben gefunden</p>
                    </div>
                `;
                return;
            }

            allTasks.forEach(task => {
                const taskCard = document.createElement('div');
                taskCard.className = 'project-card';
                taskCard.innerHTML = `
                    <div class="project-header">
                        <div class="task-info" style="flex: 1;">
                            <input type="checkbox" class="checkbox" ${task.completed ? 'checked' : ''} 
                                onchange="toggleTask(${task.id})">
                            <span class="task-name ${task.completed ? 'completed' : ''}" onclick="editTask(${task.id})">${task.name}</span>
                            <span class="deadline" style="font-size: 0.85em;">${task.projectName}</span>
                            ${task.deadline ? `<span class="deadline ${isOverdue(task.deadline) ? 'overdue' : isUrgent(task.deadline) ? 'urgent' : ''}">${formatDeadline(task.deadline)}</span>` : ''}
                        </div>
                        <div class="task-actions">
                            <button class="add-task-btn" onclick="addSubtaskToTask(${task.id}); event.stopPropagation();">+</button>
                            <button class="delete-btn" onclick="deleteTask(${task.id})">−</button>
                        </div>
                    </div>
                `;
                contentArea.appendChild(taskCard);
            });
        }

        function getProjectTasks(projectId) {
            return tasks.filter(t => t.projectId === projectId);
        }

        function getTaskSubtasks(taskId) {
            return subtasks.filter(st => st.parentTaskId === taskId);
        }

        // Projekt-Funktionen
        function openProjectModal(projectId = null) {
            const modal = document.getElementById('projectModal');
            const form = document.getElementById('projectForm');
            
            if (projectId) {
                const project = projects.find(p => p.id === projectId);
                document.getElementById('projectModalTitle').textContent = 'Projekt bearbeiten';
                document.getElementById('projectId').value = project.id;
                document.getElementById('projectName').value = project.name;
                document.getElementById('projectDescription').value = project.description || '';
            } else {
                document.getElementById('projectModalTitle').textContent = 'Neues Projekt';
                form.reset();
                document.getElementById('projectId').value = '';
            }
            
            modal.classList.add('show');
        }

        function closeProjectModal() {
            document.getElementById('projectModal').classList.remove('show');
        }

        document.getElementById('projectForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('projectId').value;
            const name = document.getElementById('projectName').value;
            const description = document.getElementById('projectDescription').value;
            
            if (id) {
                const project = projects.find(p => p.id === parseInt(id));
                project.name = name;
                project.description = description;
            } else {
                const newId = Date.now();
                projects.push({
                    id: newId,
                    name,
                    description
                });
                collapsedProjects.add(newId);
            }
            
            saveData();
            closeProjectModal();
            renderContent();
        });

        function editProject(projectId) {
            openProjectModal(projectId);
        }

        function deleteProject(projectId) {
            if (confirm('Projekt wirklich löschen?')) {
                projects = projects.filter(p => p.id !== projectId);
                const deletedTasks = tasks.filter(t => t.projectId === projectId);
                deletedTasks.forEach(task => {
                    subtasks = subtasks.filter(st => st.parentTaskId !== task.id);
                });
                tasks = tasks.filter(t => t.projectId !== projectId);
                collapsedProjects.delete(projectId);
                saveData();
                renderContent();
            }
        }

        function addTaskToProject(projectId) {
            openTaskModal(null, projectId);
        }

        // Aufgaben-Funktionen
        function openTaskModal(taskId = null, projectId = null) {
            const modal = document.getElementById('taskModal');
            const form = document.getElementById('taskForm');
            const projectSelect = document.getElementById('taskProject');
            const projectGroup = document.getElementById('taskProjectGroup');
            
            if (projectId) {
                projectGroup.style.display = 'none';
                projectSelect.removeAttribute('required');
                document.getElementById('taskProjectId').value = projectId;
            } else {
                projectGroup.style.display = 'block';
                projectSelect.setAttribute('required', 'required');
                projectSelect.innerHTML = '<option value="">Projekt wählen...</option>';
                projects.forEach(p => {
                    projectSelect.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
            }
            
            if (taskId) {
                const task = tasks.find(t => t.id === taskId);
                document.getElementById('taskModalTitle').textContent = 'Aufgabe bearbeiten';
                document.getElementById('taskId').value = task.id;
                document.getElementById('taskName').value = task.name;
                document.getElementById('taskDescription').value = task.description || '';
                document.getElementById('taskProject').value = task.projectId;
                document.getElementById('taskProjectId').value = task.projectId;
                document.getElementById('taskDeadline').value = task.deadline || '';
            } else {
                document.getElementById('taskModalTitle').textContent = 'Neue Aufgabe';
                form.reset();
                document.getElementById('taskId').value = '';
                if (projectId) {
                    document.getElementById('taskProjectId').value = projectId;
                }
            }
            
            modal.classList.add('show');
        }

        function closeTaskModal() {
            const modal = document.getElementById('taskModal');
            const projectSelect = document.getElementById('taskProject');
            const projectGroup = document.getElementById('taskProjectGroup');
            
            // Reset visibility and required attribute
            projectGroup.style.display = 'block';
            projectSelect.setAttribute('required', 'required');
            
            modal.classList.remove('show');
        }

        document.getElementById('taskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('taskId').value;
            const name = document.getElementById('taskName').value;
            const description = document.getElementById('taskDescription').value;
            const projectIdFromHidden = document.getElementById('taskProjectId').value;
            const projectIdFromSelect = document.getElementById('taskProject').value;
            const projectId = parseInt(projectIdFromHidden || projectIdFromSelect);
            const deadline = document.getElementById('taskDeadline').value;
            
            if (id) {
                const task = tasks.find(t => t.id === parseInt(id));
                task.name = name;
                task.description = description;
                task.projectId = projectId;
                task.deadline = deadline;
            } else {
                tasks.push({
                    id: Date.now(),
                    name,
                    description,
                    projectId,
                    deadline,
                    completed: false
                });
            }
            
            saveData();
            closeTaskModal();
            renderContent();
        });

        function editTask(taskId) {
            openTaskModal(taskId);
        }

        function deleteTask(taskId) {
            if (confirm('Aufgabe wirklich löschen?')) {
                subtasks = subtasks.filter(st => st.parentTaskId !== taskId);
                tasks = tasks.filter(t => t.id !== taskId);
                saveData();
                renderContent();
            }
        }

        function toggleTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            task.completed = !task.completed;
            saveData();
            renderContent();
        }

        // Unteraufgaben-Funktionen
        function addSubtaskToTask(taskId) {
            openSubtaskModal(null, taskId);
        }

        function openSubtaskModal(subtaskId = null, parentTaskId = null) {
            const modal = document.getElementById('subtaskModal');
            const form = document.getElementById('subtaskForm');
            
            if (subtaskId) {
                const subtask = subtasks.find(st => st.id === subtaskId);
                document.getElementById('subtaskModalTitle').textContent = 'Unteraufgabe bearbeiten';
                document.getElementById('subtaskId').value = subtask.id;
                document.getElementById('subtaskName').value = subtask.name;
                document.getElementById('subtaskDescription').value = subtask.description || '';
                document.getElementById('subtaskParentId').value = subtask.parentTaskId;
            } else {
                document.getElementById('subtaskModalTitle').textContent = 'Neue Unteraufgabe';
                form.reset();
                document.getElementById('subtaskId').value = '';
                document.getElementById('subtaskParentId').value = parentTaskId;
            }
            
            modal.classList.add('show');
        }

        function closeSubtaskModal() {
            document.getElementById('subtaskModal').classList.remove('show');
        }

        document.getElementById('subtaskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('subtaskId').value;
            const name = document.getElementById('subtaskName').value;
            const description = document.getElementById('subtaskDescription').value;
            const parentTaskId = parseInt(document.getElementById('subtaskParentId').value);
            
            if (id) {
                const subtask = subtasks.find(st => st.id === parseInt(id));
                subtask.name = name;
                subtask.description = description;
            } else {
                subtasks.push({
                    id: Date.now(),
                    name,
                    description,
                    parentTaskId,
                    completed: false
                });
            }
            
            saveData();
            closeSubtaskModal();
            renderContent();
        });

        function editSubtask(subtaskId) {
            openSubtaskModal(subtaskId);
        }

        function deleteSubtask(subtaskId) {
            if (confirm('Unteraufgabe wirklich löschen?')) {
                subtasks = subtasks.filter(st => st.id !== subtaskId);
                saveData();
                renderContent();
            }
        }

        function toggleSubtask(subtaskId) {
            const subtask = subtasks.find(st => st.id === subtaskId);
            subtask.completed = !subtask.completed;
            saveData();
            renderContent();
        }

        // Hilfsfunktionen
        function formatDeadline(deadline) {
            if (!deadline) return '';
            const date = new Date(deadline);
            const options = { 
                day: '2-digit', 
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            };
            return date.toLocaleString('de-DE', options);
        }

        function isOverdue(deadline) {
            if (!deadline) return false;
            return new Date(deadline) < new Date();
        }

        function isUrgent(deadline) {
            if (!deadline) return false;
            const now = new Date();
            const deadlineDate = new Date(deadline);
            const diffDays = (deadlineDate - now) / (1000 * 60 * 60 * 24);
            return diffDays >= 0 && diffDays < 3;
        }

        // Modal schließen beim Klick außerhalb
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        // App starten
        init();
    </script>
</body>
</html>
