<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Focus - ADHD Task Manager</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
        }

        :root {
            --primary: #8B7355;
            --primary-hover: #6D5A45;
            --secondary: #A0896D;
            --success: #34C759;
            --warning: #FF9500;
            --danger: #FF3B30;
            --gray-1: #F2F2F7;
            --gray-2: #E5E5EA;
            --gray-3: #D1D1D6;
            --gray-4: #C7C7CC;
            --gray-5: #AEAEB2;
            --gray-6: #8E8E93;
            --text-primary: #000000;
            --text-secondary: #3C3C43;
            --text-tertiary: #6C6C70;
            --card-bg: #FFFFFF;
            --bg: #F2F2F7;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.12);
        }

        [data-theme="dark"] {
            --primary: #B89968;
            --primary-hover: #D4B896;
            --secondary: #A0896D;
            --success: #32D74B;
            --warning: #FF9F0A;
            --danger: #FF453A;
            --gray-1: #F5F1E8;
            --gray-2: #E8E3D8;
            --gray-3: #D4CFC4;
            --gray-4: #C0BBB0;
            --gray-5: #A8A39A;
            --gray-6: #8E8A82;
            --text-primary: #000000;
            --text-secondary: #2C2C2C;
            --text-tertiary: #5A5A5A;
            --card-bg: #F5F1E8;
            --bg: #000000;
            --shadow-sm: 0 1px 3px rgba(255,255,255,0.06);
            --shadow-md: 0 4px 12px rgba(255,255,255,0.08);
            --shadow-lg: 0 8px 32px rgba(255,255,255,0.12);
        }

        [data-theme="dark"] body {
            background: #000000;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif;
            background: #F5F1E8;
            color: var(--text-primary);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
        }

        .app-container {
            max-width: 2500px;
            margin: 0 auto;
            padding: 12px 20px;
        }

        /* Auth Section */
        .auth-section {
            background: rgba(255,255,255,0.92);
            border-radius: 24px;
            padding: 60px 52px;
            max-width: 460px;
            margin: 100px auto;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .auth-logo {
            font-size: 80px;
            margin-bottom: 24px;
            animation: fadeInBounce 0.8s ease;
        }

        @keyframes fadeInBounce {
            0% { opacity: 0; transform: translateY(-30px) scale(0.8); }
            60% { transform: translateY(5px) scale(1.05); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .auth-section h1 {
            font-size: 36px;
            font-weight: 800;
            letter-spacing: -1px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #8B7355 0%, #6D5A45 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-section p {
            color: var(--text-tertiary);
            margin-bottom: 40px;
            font-size: 16px;
            line-height: 1.6;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            background: white;
            border: 2px solid var(--gray-3);
            padding: 16px 28px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            box-shadow: var(--shadow-sm);
        }

        .google-btn:hover {
            background: var(--gray-1);
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .google-btn:active {
            transform: translateY(0);
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 32px 0;
            color: var(--text-tertiary);
            font-size: 13px;
            font-weight: 500;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--gray-3);
        }

        .divider span {
            padding: 0 16px;
        }

        .offline-btn {
            background: var(--gray-1);
            color: var(--text-primary);
            border: 2px solid transparent;
            padding: 16px 28px;
            border-radius: 14px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        .offline-btn:hover {
            background: var(--gray-2);
            border-color: var(--gray-4);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        /* Cat Logo */
        .cat-logo {
            position: fixed;
            top: 20px;
            left: 20px;
            font-size: 36px;
            z-index: 1001;
            opacity: 0.8;
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }

        .cat-logo:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* Cat Speech Bubble */
        .cat-speech-bubble {
            position: fixed;
            top: 70px;
            left: 20px;
            max-width: 380px;
            background: white;
            border-radius: 20px;
            padding: 24px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
            border: 2px solid rgba(0,0,0,0.1);
            z-index: 1000;
            animation: bubbleAppear 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .cat-speech-bubble::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 30px;
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 10px solid white;
            filter: drop-shadow(0 -2px 2px rgba(0,0,0,0.1));
        }

        @keyframes bubbleAppear {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .bubble-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: var(--gray-2);
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text-tertiary);
        }

        .bubble-close:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        .bubble-content {
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .insight-item {
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(139, 115, 85, 0.05);
            border-radius: 10px;
            border-left: 3px solid var(--primary);
        }

        .insight-item:last-child {
            margin-bottom: 0;
        }

        .insight-icon {
            font-size: 18px;
            margin-right: 8px;
        }

        .insight-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .insight-text {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 10px 20px;
            background: rgba(255,255,255,0.92);
            border-radius: 30px;
            max-width: fit-content;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.06);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--primary);
        }

        .user-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sign-out-btn {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 13px;
            padding: 8px 14px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-weight: 500;
        }

        .sign-out-btn:hover {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255,255,255,0.3);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #8B7355, #34C759);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 16px 40px rgba(0,0,0,0.25);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-number {
            font-size: 40px;
            font-weight: 800;
            background: linear-gradient(135deg, #8B7355, #6D5A45);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            letter-spacing: -1.5px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-tertiary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 60px 1fr;
            gap: 20px;
            height: calc(100vh - 50px);
        }

        .main-content {
            background: rgba(255,255,255,0.92);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.06);
            overflow-y: auto;
        }

        .stats-sidebar {
            background: transparent;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            border: none;
            overflow: visible;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
        }

        .stats-sidebar h3 {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            letter-spacing: -0.3px;
        }

        .stat-card-small {
            background: linear-gradient(135deg, rgba(255,255,255,0.92) 0%, rgba(248,249,250,0.92) 100%);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0,0,0,0.04);
            position: relative;
            overflow: hidden;
        }

        .stat-card-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }

        .stat-card-small::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #8B7355, #34C759);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .stat-card-small:hover::before {
            opacity: 1;
        }

        .stat-number-small {
            font-size: 24px;
            font-weight: 800;
            background: linear-gradient(135deg, #8B7355, #6D5A45);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
            letter-spacing: -1px;
        }

        .stat-label-small {
            font-size: 10px;
            color: var(--text-tertiary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Expandable sections */
        
        /* Close button for panels */
        .panel-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--gray-2);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text-tertiary);
            z-index: 10;
        }

        .panel-close:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        /* Close expandable sections */
        .expandable-section {
            position: fixed;
            left: 100px;
            top: 80px;
            bottom: 20px;
            width: 450px;
            background: rgba(255,255,255,0.98);
            border-radius: 20px;
            padding: 28px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            border: 1px solid rgba(0,0,0,0.1);
            overflow-y: auto;
            display: none;
            z-index: 900;
            animation: slideInFromLeft 0.3s ease;
        }

        @keyframes slideInFromLeft {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .expandable-section.active {
            display: block;
        }

        .section-toggle {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.92);
            border-radius: 50%;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            border: 2px solid rgba(0,0,0,0.06);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            position: relative;
        }

        .section-toggle:hover {
            transform: translateY(-4px) scale(1.1);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            border-color: var(--primary);
        }

        .section-toggle.active {
            background: linear-gradient(135deg, #8B7355, #6D5A45);
            color: white;
            border-color: transparent;
            box-shadow: 0 6px 20px rgba(139, 115, 85, 0.5);
            transform: scale(1.1);
        }

        .section-toggle-icon {
            font-size: 20px;
        }

        /* Position toggles at bottom left */
        .stats-sidebar {
            justify-content: flex-end;
            padding-bottom: 20px;
        }

        h2 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            letter-spacing: -0.5px;
        }

        h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            letter-spacing: -0.3px;
        }

        /* Form Elements - CONSISTENT HEIGHT */
        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            letter-spacing: -0.1px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--gray-2);
            border-radius: 10px;
            font-size: 14px;
            background: var(--card-bg);
            color: var(--text-primary);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            min-height: 44px;
            line-height: 1.5;
        }

        /* Ensure ALL inputs have consistent height */
        input[type="date"],
        input[type="number"],
        input[type="text"],
        select {
            height: 44px;
            padding: 12px 14px;
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%236C6C70' d='M6 8L0 2l1.4-1.4L6 5.2 10.6.6 12 2z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 40px;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
        }

        input::placeholder, textarea::placeholder {
            color: var(--gray-5);
        }

        textarea {
            resize: vertical;
            min-height: 70px;
            padding: 12px 14px;
            line-height: 1.6;
        }

        small {
            font-size: 12px;
            color: var(--text-tertiary);
            display: block;
            margin-top: 6px;
            line-height: 1.4;
        }

        /* Buttons */
        button {
            font-family: inherit;
            font-size: 14px;
            font-weight: 600;
            padding: 11px 22px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: -0.2px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #8B7355 0%, #6D5A45 100%);
            color: white;
            width: 100%;
            box-shadow: 0 6px 20px rgba(139, 115, 85, 0.4);
            font-weight: 700;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #6D5A45 0%, #5A4A38 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 28px rgba(139, 115, 85, 0.5);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--gray-1);
            color: var(--text-primary);
            width: 100%;
            border: 2px solid transparent;
        }

        .btn-secondary:hover {
            background: var(--gray-2);
            border-color: var(--gray-3);
            transform: translateY(-1px);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .btn-icon {
            background: none;
            padding: 6px;
            font-size: 16px;
            color: var(--text-tertiary);
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-icon:hover {
            background: var(--gray-1);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        .btn-icon:active {
            transform: scale(0.95);
        }

        .btn-icon-tiny {
            background: rgba(0,0,0,0.05);
            border: none;
            width: 22px;
            height: 22px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            color: var(--text-secondary);
        }

        .btn-icon-tiny:hover {
            background: rgba(0,0,0,0.12);
            transform: scale(1.15);
        }

        /* Task Cards */
        .tasks-container {
            max-height: 900px;
            overflow-y: auto;
            margin: -6px;
            padding: 6px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .task-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.92) 0%, rgba(248,249,250,0.92) 100%);
            border-radius: 14px;
            padding: 12px;
            margin-bottom: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(0,0,0,0.04);
            position: relative;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .task-card:hover {
            border-color: rgba(139, 115, 85, 0.3);
            box-shadow: 0 8px 32px rgba(139, 115, 85, 0.2);
            transform: translateY(-4px);
        }

        .task-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 5px;
            background: linear-gradient(135deg, #8B7355, #34C759);
            border-radius: 16px 0 0 16px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .task-card:hover::before {
            opacity: 1;
        }

        .task-card.energy-matched {
            border-color: rgba(52, 199, 89, 0.4);
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.08) 0%, rgba(255,255,255,0.92) 100%);
        }

        .task-card.energy-matched::before {
            background: linear-gradient(135deg, #34C759, #30B450);
            opacity: 1;
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
            gap: 8px;
        }

        .task-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            line-height: 1.4;
            cursor: pointer;
            transition: color 0.2s;
            letter-spacing: -0.3px;
        }

        .task-title:hover {
            color: var(--primary);
        }

        .task-actions {
            display: flex;
            gap: 4px;
            flex-shrink: 0;
        }

        /* Urgency Badges */
        .urgency-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 9px;
            font-weight: 700;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .urgency-past-due {
            background: linear-gradient(135deg, rgba(255, 59, 48, 0.25), rgba(255, 59, 48, 0.2));
            color: var(--danger);
            border: 2px solid rgba(255, 59, 48, 0.4);
            animation: urgentPulse 2s infinite;
        }

        @keyframes urgentPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 4px 12px rgba(255, 59, 48, 0.4); }
        }

        .urgency-due-today {
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.25), rgba(255, 149, 0, 0.2));
            color: var(--warning);
            border: 2px solid rgba(255, 149, 0, 0.4);
        }

        .urgency-due-tomorrow {
            background: linear-gradient(135deg, rgba(255, 204, 0, 0.25), rgba(255, 204, 0, 0.2));
            color: #FF9500;
            border: 2px solid rgba(255, 204, 0, 0.4);
        }

        .urgency-better-start {
            background: linear-gradient(135deg, rgba(139, 115, 85, 0.2), rgba(139, 115, 85, 0.15));
            color: #8B7355;
            border: 2px solid rgba(139, 115, 85, 0.3);
        }

        .urgency-on-track {
            background: linear-gradient(135deg, rgba(52, 199, 89, 0.2), rgba(52, 199, 89, 0.15));
            color: var(--success);
            border: 2px solid rgba(52, 199, 89, 0.3);
        }

        .task-meta {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .task-meta-item strong {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .task-notes {
            margin-top: 8px;
            padding: 8px;
            background: rgba(139, 115, 85, 0.05);
            border-radius: 8px;
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.5;
            border: 1px solid rgba(139, 115, 85, 0.1);
        }

        /* Edit Mode */
        .task-edit-mode {
            background: var(--card-bg);
            padding: 18px;
            border-radius: 10px;
            margin-top: 14px;
            border: 2px solid var(--primary);
        }

        .edit-input {
            margin-bottom: 14px;
        }

        .edit-actions {
            display: flex;
            gap: 10px;
            margin-top: 14px;
        }

        .completed .task-title {
            text-decoration: line-through;
            opacity: 0.5;
        }

        /* Running Timer Display */
        .running-timer-display {
            position: fixed;
            bottom: 32px;
            right: 32px;
            background: linear-gradient(135deg, #34C759, #30B450);
            color: white;
            padding: 28px 32px;
            border-radius: 24px;
            box-shadow: 0 16px 64px rgba(52, 199, 89, 0.6);
            display: none;
            z-index: 1000;
            min-width: 280px;
            animation: slideInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        @keyframes slideInUp {
            from {
                transform: translateY(120px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .running-timer-display.active {
            display: block;
        }

        .timer-display-task {
            font-weight: 600;
            margin-bottom: 18px;
            font-size: 15px;
            opacity: 0.95;
            line-height: 1.4;
        }

        .timer-display-time {
            font-size: 48px;
            font-weight: 900;
            font-variant-numeric: tabular-nums;
            margin-bottom: 24px;
            letter-spacing: -2px;
            text-shadow: 0 2px 12px rgba(0,0,0,0.2);
        }

        .timer-display-actions {
            display: flex;
            gap: 12px;
        }

        .timer-display-btn {
            flex: 1;
            padding: 14px;
            background: rgba(255, 255, 255, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.4);
            color: white;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .timer-display-btn:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .timer-display-btn:active {
            transform: translateY(0);
        }

        /* Sprint Tabs */
        .sprint-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .sprint-tab {
            padding: 10px 18px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
            border: 2px solid var(--gray-3);
            background: var(--card-bg);
            color: var(--text-primary);
        }

        .sprint-tab.active {
            background: linear-gradient(135deg, #8B7355, #6D5A45);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(139, 115, 85, 0.4);
        }

        /* Project Filters */
        .project-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 16px;
            background: rgba(242,242,247,0.9);
            border-radius: 14px;
        }

        .project-filter-chip {
            padding: 8px 16px;
            background: var(--card-bg);
            border: 2px solid var(--gray-3);
            border-radius: 24px;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .project-filter-chip:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .project-filter-chip.active {
            background: linear-gradient(135deg, #8B7355, #6D5A45);
            color: white;
            border-color: transparent;
        }

        .project-filter-chip.active .btn-icon-tiny {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .project-filter-chip.active .btn-icon-tiny:hover {
            background: rgba(255,255,255,0.35);
        }

        .clear-filters {
            padding: 8px 16px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Template Builder */
        .template-builder {
            margin-top: 20px;
            padding: 20px;
            background: rgba(242,242,247,0.9);
            border-radius: 14px;
        }

        .template-task-item {
            background: var(--card-bg);
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            border: 2px solid var(--gray-2);
        }

        .template-task-info {
            flex: 1;
            font-size: 14px;
        }

        .template-task-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .template-task-details {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .add-template-task-btn {
            background: var(--card-bg);
            color: var(--text-primary);
            border: 2px dashed var(--gray-4);
            padding: 14px;
            border-radius: 10px;
            width: 100%;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .add-template-task-btn:hover {
            background: var(--gray-2);
            border-color: var(--primary);
        }

        .template-list {
            margin-top: 16px;
        }

        .template-item {
            background: rgba(242,242,247,0.9);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid var(--gray-2);
        }

        .template-info {
            flex: 1;
        }

        .template-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .template-count {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .template-actions {
            display: flex;
            gap: 8px;
        }

        /* Segmented Control */
        .segmented-control {
            display: inline-flex;
            background: var(--gray-1);
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .segment {
            padding: 8px 18px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .segment.active {
            background: var(--card-bg);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-tertiary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(12px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 28px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 24px 80px rgba(0,0,0,0.4);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-4);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-5);
        }

        /* Energy Selector */
        .energy-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .energy-option {
            flex: 1;
            padding: 12px 8px;
            border: 2px solid var(--gray-3);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            background: var(--card-bg);
        }

        .energy-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .energy-option.active {
            background: linear-gradient(135deg, #8B7355, #6D5A45);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 16px rgba(139, 115, 85, 0.4);
        }

        .energy-option div:first-child {
            font-size: 24px;
            margin-bottom: 4px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
                height: auto;
            }

            .stats-sidebar {
                flex-direction: row;
                justify-content: center;
                padding: 12px;
                gap: 16px;
            }

            .sidebar, .stats-sidebar {
                position: static;
            }

            .running-timer-display {
                bottom: 20px;
                right: 20px;
                left: 20px;
                min-width: auto;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            /* Tasks grid responsive */
            .tasks-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .tasks-container {
                grid-template-columns: 1fr;
            }
        }

        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 8px;
            margin-bottom: 12px;
        }

        .sync-btn {
            background: transparent;
            border: 1px solid var(--gray-3);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            padding: 0;
        }

        .sync-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
            transform: rotate(180deg);
        }

        .sync-btn:active {
            transform: rotate(360deg);
        }

        .sync-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success);
            box-shadow: 0 0 8px rgba(52, 199, 89, 0.6);
        }

        .sync-indicator.syncing {
            background: var(--warning);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .time-tracker {
            margin-top: 8px;
            padding: 8px 10px;
            background: var(--card-bg);
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid var(--gray-2);
        }

        .time-info {
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .running-timer {
            background: rgba(52, 199, 89, 0.1);
            border: 2px solid rgba(52, 199, 89, 0.4);
        }

        .context-alert {
            background: rgba(255, 149, 0, 0.15);
            border: 2px solid rgba(255, 149, 0, 0.4);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 20px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Settings UI */
        .settings-group {
            margin-bottom: 28px;
        }

        .settings-group h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 14px;
            color: var(--text-primary);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px;
            background: var(--card-bg);
            border-radius: 10px;
            border: 2px solid var(--gray-2);
            margin-bottom: 10px;
        }

        .setting-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .setting-description {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray-3);
            transition: 0.3s;
            border-radius: 31px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--success);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        /* Sprint Category Item */
        .sprint-category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--card-bg);
            border-radius: 10px;
            border: 2px solid var(--gray-2);
            margin-bottom: 8px;
        }

        .sprint-category-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sprint-category-icon {
            font-size: 20px;
        }

        .sprint-category-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sprint-category-energy {
            font-size: 11px;
            color: var(--text-tertiary);
            background: var(--gray-1);
            padding: 3px 8px;
            border-radius: 8px;
            margin-top: 2px;
        }

        .sprint-category-actions {
            display: flex;
            gap: 6px;
        }

        /* Mobile Navigation (hidden on desktop) */
        .mobile-nav {
            display: none;
        }

        .mobile-page {
            display: none;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 1024px) {
            /* Hide desktop layout */
            .main-grid {
                display: none !important;
            }

            .stats-sidebar {
                display: none !important;
            }

            /* Show mobile pages */
            .mobile-page {
                display: none;
                padding: 12px;
                padding-bottom: 80px;
                min-height: calc(100vh - 80px);
            }

            .mobile-page.active {
                display: block;
            }

            /* Mobile Navigation */
            .mobile-nav {
                display: flex !important;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(255,255,255,0.98);
                backdrop-filter: blur(20px);
                border-top: 1px solid rgba(0,0,0,0.1);
                box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
                padding: 6px 6px calc(6px + env(safe-area-inset-bottom));
                z-index: 1000;
                justify-content: space-around;
            }

            .mobile-nav-item {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 6px 4px;
                border-radius: 10px;
                cursor: pointer;
                transition: all 0.2s;
                border: none;
                background: transparent;
                font-size: 10px;
                color: var(--text-tertiary);
                font-weight: 600;
            }

            .mobile-nav-item.active {
                background: rgba(0, 122, 255, 0.1);
                color: var(--primary);
            }

            .mobile-nav-icon {
                font-size: 20px;
                margin-bottom: 2px;
            }

            /* Smaller mobile elements */
            .cat-logo {
                top: 10px;
                left: 10px;
                font-size: 24px;
            }

            .cat-speech-bubble {
                top: 45px;
                left: 10px;
                right: 10px;
                max-width: calc(100vw - 20px);
                padding: 16px;
            }

            .user-info {
                margin: 6px auto 6px !important;
                padding: 6px 12px !important;
                font-size: 12px !important;
            }

            .user-avatar {
                width: 24px !important;
                height: 24px !important;
            }

            .sync-status {
                font-size: 11px !important;
                margin-top: 6px !important;
                margin-bottom: 8px !important;
            }

            /* Mobile task cards */
            .mobile-page .task-card {
                padding: 12px;
                margin-bottom: 8px;
                border-radius: 12px;
            }

            .mobile-page .task-title {
                font-size: 13px;
            }

            .mobile-page .task-meta {
                font-size: 10px;
                grid-template-columns: 1fr 1fr;
                gap: 6px;
            }

            .mobile-page .task-actions {
                gap: 4px;
            }

            .mobile-page .btn-icon {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .mobile-page .urgency-badge {
                padding: 4px 8px;
                font-size: 9px;
                margin-bottom: 8px;
            }

            .mobile-page h2 {
                font-size: 18px;
                margin-bottom: 12px;
            }

            .mobile-page h3 {
                font-size: 14px;
                margin-bottom: 10px;
            }

            /* Mobile forms */
            .mobile-page .form-group {
                margin-bottom: 10px;
            }

            .mobile-page label {
                font-size: 11px;
                margin-bottom: 4px;
            }

            .mobile-page input,
            .mobile-page select,
            .mobile-page textarea {
                font-size: 16px !important; /* Prevent iOS zoom */
                padding: 9px 11px;
                min-height: 38px;
                border-radius: 8px;
            }

            .mobile-page textarea {
                min-height: 60px;
            }

            .mobile-page button {
                font-size: 13px;
                padding: 9px 16px;
                border-radius: 8px;
            }

            .mobile-page small {
                font-size: 10px;
            }

            /* Mobile stats */
            .mobile-page .stat-card-small {
                padding: 10px;
                margin-bottom: 8px;
                border-radius: 10px;
            }

            .mobile-page .stat-number-small {
                font-size: 18px;
            }

            .mobile-page .stat-label-small {
                font-size: 9px;
            }

            /* Mobile energy selector */
            .mobile-page .energy-selector {
                gap: 6px;
            }

            .mobile-page .energy-option {
                padding: 10px 6px;
                font-size: 11px;
            }

            .mobile-page .energy-option div:first-child {
                font-size: 20px;
            }

            /* Mobile insights */
            .insight-item {
                margin-bottom: 12px;
                padding: 10px;
                font-size: 12px;
            }

            .insight-title {
                font-size: 12px;
            }

            .insight-text {
                font-size: 11px;
            }

            .running-timer-display {
                bottom: 70px;
                padding: 12px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Section -->
    <div class="auth-section" id="authSection">
        <div class="auth-logo">🐱</div>
        <h1>Welcome to Focus</h1>
        <p>Your intelligent ADHD task manager that helps you stay on track</p>
        <button class="google-btn" onclick="signInWithGoogle()">
            <svg width="20" height="20" viewBox="0 0 24 24">
                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
            </svg>
            Sign in with Google
        </button>
        <div class="divider"><span>or</span></div>
        <button class="offline-btn" onclick="continueWithoutAuth()">Continue Offline</button>
        <p style="margin-top: 24px; font-size: 12px; color: var(--text-tertiary);">
            Offline mode saves data locally on this device only
        </p>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer" style="display: none;">
        <!-- Update Available Banner -->
        <div id="updateBanner" style="display: none; position: fixed; top: 0; left: 0; right: 0; background: linear-gradient(135deg, #8B7355, #6D5A45); color: white; padding: 12px 20px; text-align: center; z-index: 2000; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
            <span style="font-size: 14px; font-weight: 600;">🎉 New version available!</span>
            <button onclick="location.reload(true)" style="margin-left: 12px; background: white; color: #8B7355; border: none; padding: 6px 16px; border-radius: 6px; font-weight: 600; cursor: pointer;">Refresh Now</button>
        </div>
        
        <div class="cat-logo" id="catLogo">🐱</div>
        
        <!-- Floating Cat Speech Bubble -->
        <div class="cat-speech-bubble" id="catSpeechBubble" style="display: none;">
            <button class="bubble-close" onclick="closeCatInsights()">✕</button>
            <div class="bubble-content" id="catInsightsContent"></div>
        </div>
        
        <div class="user-info" id="userInfo" style="display: none; margin: 12px auto 12px;">
            <img class="user-avatar" id="userAvatar" src="" alt="">
            <span class="user-name" id="userName"></span>
            <button class="sign-out-btn" onclick="signOut()">Sign Out</button>
        </div>
        <div class="sync-status" id="syncStatus" style="display: none;">
            <span class="sync-indicator" id="syncIndicator"></span>
            <span id="syncText">Synced</span>
            <button onclick="manualSync()" class="sync-btn" title="Sync Now">🔄</button>
        </div>

        <div class="main-grid">
            <!-- Left Sidebar - Circular Toggle Buttons -->
            <div class="stats-sidebar">
                <div class="section-toggle" id="statsToggle" onclick="toggleSection('stats')" title="Statistics">
                    <span class="section-toggle-icon">📊</span>
                </div>
                
                <div class="section-toggle" id="templatesToggle" onclick="toggleSection('templates')" title="Templates">
                    <span class="section-toggle-icon">📋</span>
                </div>

                <div class="section-toggle" id="energyToggle" onclick="toggleSection('energy')" title="Energy Level">
                    <span class="section-toggle-icon">⚡</span>
                </div>

                <div class="section-toggle" id="timerToggle" onclick="toggleSection('timer')" title="Time Tracker">
                    <span class="section-toggle-icon">⏱</span>
                </div>

                <div class="section-toggle" id="addTaskToggle" onclick="toggleSection('addTask')" title="Add Task">
                    <span class="section-toggle-icon">➕</span>
                </div>

                <div class="section-toggle" id="settingsToggle" onclick="toggleSection('settings')" title="Settings">
                    <span class="section-toggle-icon">⚙️</span>
                </div>
            </div>

            <!-- Middle Column - Add Task OR Expanded Section -->
            <div class="expandable-section" id="addTaskSection">
                <button class="panel-close" onclick="closeAllPanels()" title="Close">✕</button>
                <h2>Add Task</h2>
                
                <div class="context-alert" id="contextAlert" style="display:none;">
                    ⚠️ Switching from <span id="lastSprint"></span> to different sprint. Remember: 15min transition!
                </div>

                <form id="taskForm">
                    <div class="form-group">
                        <label>Task Name</label>
                        <input type="text" id="taskName" required placeholder="What needs to be done?">
                    </div>

                    <div class="form-group">
                        <label>Sprint Category</label>
                        <select id="sprintCategory" required>
                            <option value="urgent">Sprint 1: Urgent</option>
                            <option value="deadlines">Sprint 2: Deadlines</option>
                            <option value="admin">Sprint 3: Admin</option>
                            <option value="creative">Sprint 4: Creative</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Project (optional)</label>
                        <div style="display: flex; gap: 8px;">
                            <select id="projectName" style="flex: 1;">
                                <option value="">No Project</option>
                            </select>
                            <button type="button" class="btn-secondary" onclick="showAddProjectModal()" style="width: auto; padding: 0 16px;">+ New</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Final Deadline</label>
                        <input type="date" id="finalDeadline" required>
                    </div>

                    <div class="form-group">
                        <label>Lead Days</label>
                        <input type="number" id="leadDays" min="0" value="0" placeholder="0">
                        <small>Days before deadline to complete this</small>
                    </div>


                    <div class="form-group">
                        <label>Estimated Time (minutes)</label>
                        <input type="number" id="estimatedTime" min="5" step="5" placeholder="30">
                    </div>

                    <div class="form-group">
                        <label>Dependencies (optional)</label>
                        <input type="text" id="dependencies" placeholder="Task names separated by commas" list="tasksList">
                        <datalist id="tasksList"></datalist>
                        <small>Enter multiple task names separated by commas</small>
                    </div>

                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="taskNotes" placeholder="Additional details..."></textarea>
                    </div>

                    <button type="submit" class="btn-primary">Add Task</button>
                </form>
            </div>

            <!-- Expanded Stats Section -->
            <div class="expandable-section" id="statsSection">
                <button class="panel-close" onclick="closeAllPanels()" title="Close">✕</button>
                <h2>📊 Statistics</h2>
                <div class="stat-card-small">
                    <div class="stat-number-small" id="totalTasks">0</div>
                    <div class="stat-label-small">Total Tasks</div>
                </div>
                <div class="stat-card-small">
                    <div class="stat-number-small" id="urgentTasks">0</div>
                    <div class="stat-label-small">Urgent Today</div>
                </div>
                <div class="stat-card-small">
                    <div class="stat-number-small" id="completedTasks">0</div>
                    <div class="stat-label-small">Completed</div>
                </div>
                <div class="stat-card-small">
                    <div class="stat-number-small" id="completionRate">0%</div>
                    <div class="stat-label-small">Success Rate</div>
                </div>
                <div class="stat-card-small">
                    <div class="stat-number-small" id="avgAccuracy">--</div>
                    <div class="stat-label-small">Time Accuracy</div>
                </div>
            </div>

            <!-- Expanded Templates Section -->
            <div class="expandable-section" id="templatesSection">
                <button class="panel-close" onclick="closeAllPanels()" title="Close">✕</button>
                <h2>📋 Templates</h2>
                    
                    <!-- Template Builder -->
                    <div class="template-builder" id="templateBuilder" style="display: none;">
                        <h3 style="font-size: 16px; margin-bottom: 14px;">Create Template</h3>
                        <div class="form-group">
                            <input type="text" id="newTemplateName" placeholder="Template name" style="margin-bottom: 14px;">
                        </div>
                        <div id="templateTasksList"></div>
                        <button class="add-template-task-btn" onclick="addTemplateTask()">+ Add Task</button>
                        <div style="display: flex; gap: 10px; margin-top: 14px;">
                            <button class="btn-secondary" onclick="cancelTemplateBuilder()" style="width: auto; flex: 1;">Cancel</button>
                            <button class="btn-primary" onclick="saveNewTemplate()" style="width: auto; flex: 1;">Save</button>
                        </div>
                    </div>

                    <button class="btn-secondary" onclick="showTemplateBuilder()" id="showTemplateBuilderBtn">+ Create Template</button>
                    <button class="btn-secondary" onclick="saveCurrentAsTemplate()" style="margin-top: 10px;">Save Active Tasks</button>
                    
                    <div class="template-list" id="templateList"></div>
                </div>

            <!-- Expanded Energy Section -->
            <div class="expandable-section" id="energySection">
                <button class="panel-close" onclick="closeAllPanels()" title="Close">✕</button>
                <h2>⚡ Energy Level</h2>
                <h3>Current Energy Level</h3>
                <div class="energy-selector">
                    <div class="energy-option" onclick="setEnergy('low')" id="energyLow">
                        <div>😴</div>
                        <div>Low</div>
                    </div>
                    <div class="energy-option active" onclick="setEnergy('medium')" id="energyMedium">
                        <div>😐</div>
                        <div>Medium</div>
                    </div>
                    <div class="energy-option" onclick="setEnergy('high')" id="energyHigh">
                        <div>⚡</div>
                        <div>High</div>
                    </div>
                </div>
                <div id="energyRecommendation" style="font-size: 12px; color: var(--text-tertiary); margin-top: 12px; padding: 12px; background: var(--gray-1); border-radius: 8px;"></div>
            </div>

            <!-- Expanded Timer Section -->
            <div class="expandable-section" id="timerSection">
                <button class="panel-close" onclick="closeAllPanels()" title="Close">✕</button>
                <h2>⏱ Time Tracker</h2>
                
                <div id="timerTaskSelector" style="margin-bottom: 20px;">
                    <label style="display: block; font-size: 13px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">Select Task to Track</label>
                    <select id="timerTaskDropdown" style="width: 100%; padding: 12px 14px; border: 2px solid var(--gray-2); border-radius: 10px; font-size: 14px; background: var(--card-bg); color: var(--text-primary);">
                        <option value="">-- Select a task --</option>
                    </select>
                </div>

                <div id="timerDisplay" style="text-align: center; margin: 30px 0;">
                    <div id="timerTaskName" style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 20px;">No task selected</div>
                    <div id="timerTime" style="font-size: 56px; font-weight: 900; font-variant-numeric: tabular-nums; color: var(--text-primary); margin-bottom: 24px; letter-spacing: -2px;">00:00</div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button id="timerStartBtn" class="btn-primary" onclick="startTimerFromPanel()" style="width: auto; padding: 14px 28px;" disabled>Start Timer</button>
                        <button id="timerStopBtn" class="btn-secondary" onclick="stopTimerFromPanel()" style="width: auto; padding: 14px 28px; display: none;">Stop Timer</button>
                    </div>
                </div>

                <div id="timerTaskInfo" style="background: var(--gray-1); border-radius: 10px; padding: 14px; font-size: 13px; color: var(--text-secondary); display: none;">
                    <div style="margin-bottom: 8px;"><strong>Sprint:</strong> <span id="timerInfoSprint">--</span></div>
                    <div style="margin-bottom: 8px;"><strong>Deadline:</strong> <span id="timerInfoDeadline">--</span></div>
                    <div><strong>Estimated Time:</strong> <span id="timerInfoEstTime">--</span></div>
                </div>
            </div>

            <!-- Expanded Settings Section -->
            <div class="expandable-section" id="settingsSection">
                <button class="panel-close" onclick="closeAllPanels()" title="Close">✕</button>
                <h2>⚙️ Settings</h2>
                
                <!-- Dark Mode -->
                <div class="settings-group">
                    <h3>Appearance</h3>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Dark Mode</div>
                            <div class="setting-description">Switch to dark theme</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <!-- Sprint Categories -->
                <div class="settings-group">
                    <h3>Sprint Categories</h3>
                    <div id="sprintCategoriesList"></div>
                    <button class="btn-secondary" onclick="showAddSprintModal()" style="width: 100%; margin-top: 12px;">+ Add Sprint Category</button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <h2 style="margin-bottom: 24px;">Tasks</h2>

                <!-- Project Filters -->
                <div class="project-filters" id="projectFilters" style="display: none;"></div>

                <!-- List View -->
                <div id="listView">
                    <div class="segmented-control" style="margin-bottom: 20px;">
                        <button class="segment active" onclick="filterTasks('all')">All</button>
                        <button class="segment" onclick="filterTasks('active')">Active</button>
                        <button class="segment" onclick="filterTasks('completed')">Done</button>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
                        <div class="sprint-tabs" style="margin: 0;">
                            <div class="sprint-tab active" onclick="filterBySprint('all')">All</div>
                            <div class="sprint-tab" id="sprintTab-urgent" onclick="filterBySprint('urgent')">🔥 Urgent</div>
                            <div class="sprint-tab" id="sprintTab-deadlines" onclick="filterBySprint('deadlines')">⏰ Deadlines</div>
                            <div class="sprint-tab" id="sprintTab-admin" onclick="filterBySprint('admin')">📋 Admin</div>
                            <div class="sprint-tab" id="sprintTab-creative" onclick="filterBySprint('creative')">🎨 Creative</div>
                        </div>
                        
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 12px; color: var(--text-tertiary); font-weight: 600;">Sort:</label>
                            <select id="sortTasks" onchange="changeSortOrder(this.value)" style="padding: 6px 10px; border-radius: 8px; border: 2px solid var(--gray-3); background: var(--card-bg); font-size: 12px; font-weight: 600; cursor: pointer;">
                                <option value="urgency">By Urgency</option>
                                <option value="deadline">By Deadline</option>
                                <option value="created">By Date Created</option>
                            </select>
                        </div>
                    </div>

                    <div class="tasks-container" id="tasksContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">📝</div>
                            <p>No tasks yet. Add your first task!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Pages (shown only on mobile) -->
        <!-- Tasks Page -->
        <div class="mobile-page active" id="mobileTasks">
            <h2>My Tasks</h2>
            <div class="tasks-container" id="mobileTasksContainer"></div>
        </div>

        <!-- Add Task Page -->
        <div class="mobile-page" id="mobileAddTask">
            <h2>Add Task</h2>
            <form id="mobileTaskForm">
                <div class="form-group">
                    <label>Task Name</label>
                    <input type="text" id="mobileTaskName" required placeholder="What needs to be done?">
                </div>
                <div class="form-group">
                    <label>Sprint Category</label>
                    <select id="mobileSprintCategory" required>
                        <option value="urgent">Sprint 1: Urgent</option>
                        <option value="deadlines">Sprint 2: Deadlines</option>
                        <option value="admin">Sprint 3: Admin</option>
                        <option value="creative">Sprint 4: Creative</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Project (optional)</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="mobileProjectName" style="flex: 1;">
                            <option value="">No Project</option>
                        </select>
                        <button type="button" class="btn-secondary" onclick="showAddProjectModal()" style="width: auto; padding: 0 14px; font-size: 13px;">+</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Final Deadline</label>
                    <input type="date" id="mobileFinalDeadline" required>
                </div>
                <div class="form-group">
                    <label>Lead Days</label>
                    <input type="number" id="mobileLeadDays" min="0" value="0" placeholder="0">
                    <small>Days before deadline to complete this</small>
                </div>
                <div class="form-group">
                    <label>Estimated Time (minutes)</label>
                    <input type="number" id="mobileEstimatedTime" min="5" step="5" placeholder="30">
                </div>
                <div class="form-group">
                    <label>Dependencies (optional)</label>
                    <input type="text" id="mobileDependencies" placeholder="Task names separated by commas" list="mobileTasksList">
                    <datalist id="mobileTasksList"></datalist>
                    <small>Enter multiple task names separated by commas</small>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="mobileTaskNotes" placeholder="Additional details..."></textarea>
                </div>
                <button type="submit" class="btn-primary">Add Task</button>
            </form>
        </div>

        <!-- Stats Page -->
        <div class="mobile-page" id="mobileStats">
            <h2>📊 Statistics</h2>
            <div class="stat-card-small">
                <div class="stat-number-small" id="mobileTotalTasks">0</div>
                <div class="stat-label-small">Total Tasks</div>
            </div>
            <div class="stat-card-small">
                <div class="stat-number-small" id="mobileUrgentTasks">0</div>
                <div class="stat-label-small">Urgent Today</div>
            </div>
            <div class="stat-card-small">
                <div class="stat-number-small" id="mobileCompletedTasks">0</div>
                <div class="stat-label-small">Completed</div>
            </div>
            <div class="stat-card-small">
                <div class="stat-number-small" id="mobileCompletionRate">0%</div>
                <div class="stat-label-small">Success Rate</div>
            </div>
            <div class="stat-card-small">
                <div class="stat-number-small" id="mobileAvgAccuracy">--</div>
                <div class="stat-label-small">Time Accuracy</div>
            </div>
        </div>

        <!-- Energy Page -->
        <div class="mobile-page" id="mobileEnergy">
            <h2>⚡ Energy Level</h2>
            <h3>Current Energy Level</h3>
            <div class="energy-selector">
                <div class="energy-option" onclick="setEnergy('low')" id="mobileEnergyLow">
                    <div>😴</div>
                    <div>Low</div>
                </div>
                <div class="energy-option active" onclick="setEnergy('medium')" id="mobileEnergyMedium">
                    <div>😐</div>
                    <div>Medium</div>
                </div>
                <div class="energy-option" onclick="setEnergy('high')" id="mobileEnergyHigh">
                    <div>⚡</div>
                    <div>High</div>
                </div>
            </div>
            <div id="mobileEnergyRecommendation" style="font-size: 12px; color: var(--text-tertiary); margin-top: 12px; padding: 12px; background: var(--gray-1); border-radius: 8px;"></div>
        </div>

        <!-- Mobile Bottom Navigation -->
        <nav class="mobile-nav">
            <button class="mobile-nav-item active" onclick="showMobilePage('tasks')">
                <div class="mobile-nav-icon">✓</div>
                <div>Tasks</div>
            </button>
            <button class="mobile-nav-item" onclick="showMobilePage('add')">
                <div class="mobile-nav-icon">+</div>
                <div>Add</div>
            </button>
            <button class="mobile-nav-item" onclick="showMobilePage('stats')">
                <div class="mobile-nav-icon">📊</div>
                <div>Stats</div>
            </button>
            <button class="mobile-nav-item" onclick="showMobilePage('energy')">
                <div class="mobile-nav-icon">⚡</div>
                <div>Energy</div>
            </button>
            <button class="mobile-nav-item" onclick="toggleInsights()">
                <div class="mobile-nav-icon">💡</div>
                <div>Tips</div>
            </button>
        </nav>
    </div>

    <!-- Running Timer Display -->
    <div class="running-timer-display" id="runningTimerDisplay">
        <div class="timer-display-task" id="timerTaskName">Task Name</div>
        <div class="timer-display-time" id="timerTime">00:00</div>
        <div class="timer-display-actions">
            <button class="timer-display-btn" onclick="stopTimerFromDisplay()">Stop</button>
            <button class="timer-display-btn" onclick="closeTimerDisplay()">Hide</button>
        </div>
    </div>

    <!-- Edit Task Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Task</h2>
                <button class="btn-icon" onclick="closeEditModal()">✕</button>
            </div>
            <div id="editModalContent"></div>
        </div>
    </div>

    <!-- Template Task Modal -->
    <div class="modal" id="templateTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Template Task</h2>
                <button class="btn-icon" onclick="closeTemplateTaskModal()">✕</button>
            </div>
            <form id="templateTaskForm">
                <div class="form-group">
                    <label>Task Name</label>
                    <input type="text" id="templateTaskName" required placeholder="Task name">
                </div>
                <div class="form-group">
                    <label>Sprint</label>
                    <select id="templateTaskSprint">
                        <option value="urgent">Urgent</option>
                        <option value="deadlines">Deadlines</option>
                        <option value="admin">Admin</option>
                        <option value="creative">Creative</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Lead Days</label>
                    <input type="number" id="templateTaskLeadDays" value="0" min="0">
                </div>
                <div class="form-group">
                    <label>Estimated Time (minutes)</label>
                    <input type="number" id="templateTaskTime" step="5" placeholder="30">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="templateTaskNotes" placeholder="Optional"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 24px;">
                    <button type="button" class="btn-secondary" onclick="closeTemplateTaskModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn-primary" style="flex: 1;">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Project Modal -->
    <div class="modal" id="addProjectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">New Project</h2>
                <button class="btn-icon" onclick="closeAddProjectModal()">✕</button>
            </div>
            <form id="addProjectForm">
                <div class="form-group">
                    <label>Project Name</label>
                    <input type="text" id="newProjectName" required placeholder="e.g., Website Redesign" autofocus>
                </div>
                <div class="form-group">
                    <label>Description (optional)</label>
                    <textarea id="newProjectDescription" placeholder="What is this project about?"></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 24px;">
                    <button type="button" class="btn-secondary" onclick="closeAddProjectModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn-primary" style="flex: 1;">Create Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Sprint Category Modal -->
    <div class="modal" id="sprintModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="sprintModalTitle">New Sprint Category</h2>
                <button class="btn-icon" onclick="closeSprintModal()">✕</button>
            </div>
            <form id="sprintForm">
                <div class="form-group">
                    <label>Category Name</label>
                    <input type="text" id="sprintName" required placeholder="e.g., Focus Work">
                </div>
                <div class="form-group">
                    <label>Emoji Icon</label>
                    <input type="text" id="sprintIcon" required placeholder="e.g., 🎯" maxlength="2">
                </div>
                <div class="form-group">
                    <label>Energy Level Match</label>
                    <select id="sprintEnergy">
                        <option value="">No energy match</option>
                        <option value="low">Low Energy</option>
                        <option value="medium">Medium Energy</option>
                        <option value="high">High Energy</option>
                    </select>
                    <small>Tasks in this sprint will be highlighted when your energy matches</small>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 24px;">
                    <button type="button" class="btn-secondary" onclick="closeSprintModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn-primary" style="flex: 1;">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCOSbBJYqy6TsaqeU-Ww0HnKW_VkBVj6nY",
            authDomain: "focus-be3bf.firebaseapp.com",
            projectId: "focus-be3bf",
            storageBucket: "focus-be3bf.firebasestorage.app",
            messagingSenderId: "172124384981",
            appId: "1:172124384981:web:2856abe66e0d2c2661bc5c",
            measurementId: "G-FLZRKN5RXY"
        };

        // Initialize Firebase
        let app, auth, db;
        let currentUser = null;
        let useFirebase = false;

        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            useFirebase = true;
        } catch (error) {
            console.log('Firebase not configured - using offline mode');
            useFirebase = false;
        }

        // Global State
        let tasks = [];
        let templates = [];
        let projects = [];
        let currentSprintFilter = 'all';
        let currentStatusFilter = 'all';
        let currentView = 'list';
        let currentEnergy = 'medium';
        let lastCompletedSprint = null;
        let editingTaskId = null;
        let templateTasks = [];
        let selectedProjectFilters = [];
        let timerInterval = null;
        let runningTimerTaskId = null;
        let activeSection = null;
        let currentSortOrder = 'urgency';
        let sprintCategories = [
            { id: 'urgent', name: 'Urgent', icon: '🔥', energy: 'medium', deletable: false },
            { id: 'deadlines', name: 'Deadlines', icon: '⏰', energy: 'medium', deletable: false },
            { id: 'admin', name: 'Admin', icon: '📋', energy: 'low', deletable: false },
            { id: 'creative', name: 'Creative', icon: '🎨', energy: 'high', deletable: false }
        ];

        // App version for cache busting
        const APP_VERSION = '1.0.9';
        
        // Check for updates on load
        function checkForUpdates() {
            const storedVersion = localStorage.getItem('appVersion');
            if (storedVersion && storedVersion !== APP_VERSION) {
                console.log('New version detected, clearing cache');
                // Show update banner
                const banner = document.getElementById('updateBanner');
                if (banner) {
                    banner.style.display = 'block';
                }
                // Clear service worker cache if it exists
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(registrations => {
                        registrations.forEach(registration => registration.update());
                    });
                }
            }
            localStorage.setItem('appVersion', APP_VERSION);
        }
        
        // Run on load
        window.addEventListener('load', checkForUpdates);

        // Toggle Section Function
        
        // Close all panels
        function closeAllPanels() {
            document.querySelectorAll('.expandable-section').forEach(sec => {
                sec.classList.remove('active');
            });
            document.querySelectorAll('.section-toggle').forEach(toggle => {
                toggle.classList.remove('active');
            });
        }
        // Close panels when clicking outside
        document.addEventListener('click', function(e) {
            const panels = document.querySelectorAll('.expandable-section.active');
            const toggles = document.querySelectorAll('.section-toggle');
            
            let clickedToggle = false;
            let clickedPanel = false;
            
            // Check if clicked on a toggle
            toggles.forEach(toggle => {
                if (toggle.contains(e.target)) {
                    clickedToggle = true;
                }
            });
            
            // Check if clicked inside a panel
            panels.forEach(panel => {
                if (panel.contains(e.target)) {
                    clickedPanel = true;
                }
            });
            
            // If clicked outside both toggle and panel, close all
            if (!clickedToggle && !clickedPanel) {
                closeAllPanels();
            }
        });

        

        function toggleSection(section) {
            // Close all sections first
            document.querySelectorAll('.expandable-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            // Remove active state from all toggles
            document.querySelectorAll('.section-toggle').forEach(toggle => {
                toggle.classList.remove('active');
            });
            
            // Open the selected section
            const sectionElement = document.getElementById(section + 'Section');
            const toggleElement = document.getElementById(section + 'Toggle');
            
            if (sectionElement) {
                sectionElement.classList.add('active');
                if (toggleElement) {
                    toggleElement.classList.add('active');
                }
                
                // Focus on first input if it's add task
                if (section === 'addTask') {
                    setTimeout(() => {
                        const taskNameInput = document.getElementById('taskName');
                        if (taskNameInput) taskNameInput.focus();
                    }, 300);
                }
                
                // Populate timer dropdown if it's timer section
                if (section === 'timer') {
                    populateTimerDropdown();
                }
            }
        }

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            if (useFirebase) {
                auth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = user;
                        showApp();
                        loadDataFromFirebase();
                    } else {
                        showAuth();
                    }
                });
            } else {
                showAuth();
            }
        });

        // Auth Functions
        function signInWithGoogle() {
            if (!useFirebase) {
                alert('⚠️ Firebase not configured!\n\nTo enable Google sign-in:\n1. Create a Firebase project\n2. Add your config to the code\n3. Enable Google Authentication\n\nFor now, click "Continue Offline"');
                return;
            }
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    currentUser = result.user;
                    showApp();
                    loadDataFromFirebase();
                })
                .catch((error) => {
                    alert('Sign in failed: ' + error.message);
                });
        }

        function signOut() {
            if (useFirebase && auth && currentUser) {
                auth.signOut().then(() => {
                    currentUser = null;
                    tasks = [];
                    templates = [];
                    projects = [];
                    showAuth();
                });
            } else {
                if (confirm('Clear all local data?')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        }

        function continueWithoutAuth() {
            loadDataFromLocalStorage();
            showApp();
        }

        function showAuth() {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('appContainer').style.display = 'none';
        }

        function showApp() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            
            if (currentUser) {
                document.getElementById('userInfo').style.display = 'flex';
                document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
                document.getElementById('userAvatar').src = currentUser.photoURL || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="36" height="36"%3E%3Ccircle cx="18" cy="18" r="18" fill="%23667eea"/%3E%3C/svg%3E';
                document.getElementById('syncStatus').style.display = 'flex';
            }
            
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('finalDeadline').value = tomorrow.toISOString().split('T')[0];
            
            renderTasks();
            renderTemplates();
            updateStats();
            updateInsights();
            updateProjectFilters();
            setEnergy(currentEnergy);
            
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateRunningTimerDisplay, 1000);
        }

        // Data Persistence
        function loadDataFromFirebase() {
            if (!useFirebase || !currentUser) return;
            
            setSyncStatus('syncing');
            const userRef = db.collection('users').doc(currentUser.uid);
            
            Promise.all([
                userRef.collection('tasks').get(),
                userRef.collection('templates').get(),
                userRef.collection('projects').get()
            ]).then(([tasksSnap, templatesSnap, projectsSnap]) => {
                tasks = tasksSnap.docs.map(doc => ({...doc.data(), id: doc.id}));
                templates = templatesSnap.docs.map(doc => ({...doc.data(), id: doc.id}));
                projects = projectsSnap.docs.map(doc => ({...doc.data(), id: doc.id}));
                
                renderTasks();
                renderTemplates();
                updateStats();
                updateInsights();
                updateProjectFilters();
                setSyncStatus('synced');
            }).catch(error => {
                console.error('Error loading:', error);
                loadDataFromLocalStorage();
                setSyncStatus('synced');
            });
        }

        function loadDataFromLocalStorage() {
            tasks = JSON.parse(localStorage.getItem('focusTasks')) || [];
            templates = JSON.parse(localStorage.getItem('focusTemplates')) || [];
            projects = JSON.parse(localStorage.getItem('focusProjects')) || [];
            currentEnergy = localStorage.getItem('currentEnergy') || 'medium';
            lastCompletedSprint = localStorage.getItem('lastCompletedSprint');
        }

        function saveTasks() {
            localStorage.setItem('focusTasks', JSON.stringify(tasks));
            
            if (useFirebase && currentUser) {
                setSyncStatus('syncing');
                const batch = db.batch();
                const userRef = db.collection('users').doc(currentUser.uid);
                
                tasks.forEach(task => {
                    const taskRef = userRef.collection('tasks').doc(String(task.id));
                    batch.set(taskRef, task);
                });
                
                batch.commit().then(() => {
                    setSyncStatus('synced');
                }).catch(error => {
                    console.error('Sync error:', error);
                    setSyncStatus('synced');
                });
            }
        }

        function saveTemplates() {
            localStorage.setItem('focusTemplates', JSON.stringify(templates));
            
            if (useFirebase && currentUser) {
                const userRef = db.collection('users').doc(currentUser.uid);
                templates.forEach(template => {
                    userRef.collection('templates').doc(String(template.id)).set(template);
                });
            }
        }

        function saveProjects() {
            localStorage.setItem('focusProjects', JSON.stringify(projects));
            
            if (useFirebase && currentUser) {
                const userRef = db.collection('users').doc(currentUser.uid);
                projects.forEach(project => {
                    userRef.collection('projects').doc(String(project.id)).set(project);
                });
            }
        }

        function setSyncStatus(status) {
            const indicator = document.getElementById('syncIndicator');
            const text = document.getElementById('syncText');
            
            if (status === 'syncing') {
                indicator.classList.add('syncing');
                text.textContent = 'Syncing...';
            } else {
                indicator.classList.remove('syncing');
                text.textContent = 'Synced';
            }
        }

        // Manual Sync Function
        function manualSync() {
            if (!useFirebase || !currentUser) {
                alert('Not connected to cloud. Sign in to sync.');
                return;
            }
            
            setSyncStatus('syncing');
            
            // Force save all data
            const promises = [];
            
            // Sync tasks
            const batch = db.batch();
            const userRef = db.collection('users').doc(currentUser.uid);
            
            tasks.forEach(task => {
                const taskRef = userRef.collection('tasks').doc(String(task.id));
                batch.set(taskRef, task);
            });
            
            promises.push(batch.commit());
            
            // Sync projects
            projects.forEach(project => {
                promises.push(
                    userRef.collection('projects').doc(String(project.id)).set(project)
                );
            });
            
            // Sync templates
            templates.forEach(template => {
                promises.push(
                    userRef.collection('templates').doc(String(template.id)).set(template)
                );
            });
            
            Promise.all(promises)
                .then(() => {
                    setSyncStatus('synced');
                    console.log('Manual sync completed');
                })
                .catch(error => {
                    console.error('Manual sync error:', error);
                    alert('Sync failed. Check your connection.');
                    setSyncStatus('synced');
                });
        }

        // Task Form Submit
        document.getElementById('taskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const projectName = document.getElementById('projectName').value.trim();
            const dependenciesInput = document.getElementById('dependencies').value.trim();
            const dependenciesArray = dependenciesInput ? dependenciesInput.split(',').map(d => d.trim()).filter(d => d) : [];
            
            const task = {
                id: Date.now(),
                name: document.getElementById('taskName').value,
                sprint: document.getElementById('sprintCategory').value,
                project: projectName || null,
                finalDeadline: document.getElementById('finalDeadline').value,
                leadDays: parseInt(document.getElementById('leadDays').value) || 0,
                urgencyScore: getSprintBaseUrgency(document.getElementById('sprintCategory').value),
                estimatedTime: parseInt(document.getElementById('estimatedTime').value) || 0,
                notes: document.getElementById('taskNotes').value,
                dependencies: dependenciesArray,
                completed: false,
                createdAt: new Date().toISOString(),
                actualTime: 0,
                timerRunning: false,
                timerStart: null
            };
            
            tasks.push(task);
            
            if (projectName) {
                let project = projects.find(p => p.name === projectName);
                if (project && !project.taskIds.includes(task.id)) {
                    project.taskIds.push(task.id);
                    saveProjects();
                }
            }
            
            saveTasks();
            renderTasks();
            updateStats();
            updateInsights();
            updateProjectFilters();
            updateDataLists();
            
            this.reset();
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('finalDeadline').value = tomorrow.toISOString().split('T')[0];
            
            checkContextSwitching(task.sprint);
        });

        // Task Functions
        function calculateAutoDeadline(finalDeadline, leadDays) {
            const deadline = new Date(finalDeadline);
            deadline.setDate(deadline.getDate() - leadDays);
            return deadline;
        }

        function calculateUrgency(autoDeadline) {
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            const deadline = new Date(autoDeadline);
            deadline.setHours(0, 0, 0, 0);
            
            const diffDays = Math.floor((deadline - now) / (1000 * 60 * 60 * 24));
            
            console.log('Urgency check:', {
                today: now.toLocaleDateString(),
                deadline: deadline.toLocaleDateString(),
                diffDays: diffDays
            });
            
            if (diffDays < 0) return { level: 'past-due', text: 'PAST DUE' };
            if (diffDays === 0) return { level: 'due-today', text: 'DUE TODAY' };
            if (diffDays === 1) return { level: 'due-tomorrow', text: 'DUE TOMORROW' };
            if (diffDays <= 3) return { level: 'better-start', text: 'START SOON' };
            return { level: 'on-track', text: 'ON TRACK' };
        }

        function renderTasks() {
            const container = document.getElementById('tasksContainer');
            
            let filteredTasks = tasks.filter(task => {
                const sprintMatch = currentSprintFilter === 'all' || task.sprint === currentSprintFilter;
                const statusMatch = currentStatusFilter === 'all' || 
                                  (currentStatusFilter === 'active' && !task.completed) ||
                                  (currentStatusFilter === 'completed' && task.completed);
                
                let projectMatch = true;
                if (selectedProjectFilters.length > 0) {
                    projectMatch = task.project && selectedProjectFilters.includes(task.project);
                }
                
                return sprintMatch && statusMatch && projectMatch;
            });

            filteredTasks = sortTasks(filteredTasks);

            if (filteredTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✓</div>
                        <p>No tasks match your filters</p>
                    </div>
                `;
                return;
            }

            // Determine energy match
            const energyMatch = {
                low: 'admin',
                medium: ['urgent', 'deadlines'],
                high: 'creative'
            };

            container.innerHTML = filteredTasks.map(task => {
                const autoDeadline = calculateAutoDeadline(task.finalDeadline, task.leadDays);
                const urgency = calculateUrgency(autoDeadline);
                const dynamicUrgency = calculateDynamicUrgency(task);
                
                // Check if task matches current energy level
                let isEnergyMatched = false;
                if (currentEnergy === 'low' && task.sprint === energyMatch.low) {
                    isEnergyMatched = true;
                } else if (currentEnergy === 'medium' && energyMatch.medium.includes(task.sprint)) {
                    isEnergyMatched = true;
                } else if (currentEnergy === 'high' && task.sprint === energyMatch.high) {
                    isEnergyMatched = true;
                }
                
                return `
                    <div class="task-card ${task.completed ? 'completed' : ''} ${isEnergyMatched ? 'energy-matched' : ''}" id="task-${task.id}">
                        <div class="task-header">
                            <div class="task-title">${task.name}
                                ${task.project ? `<div style="font-size: 13px; color: var(--text-tertiary); margin-top: 6px;">📁 ${task.project}</div>` : ''}
                            </div>
                            <div class="task-actions">
                                <button class="btn-icon" onclick="toggleComplete(${task.id})" title="${task.completed ? 'Mark incomplete' : 'Complete'}">
                                    ${task.completed ? '✓' : '○'}
                                </button>
                                <button class="btn-icon" onclick="openEditModal(${task.id})" title="Edit">✏️</button>
                                <button class="btn-icon" onclick="duplicateTask(${task.id})" title="Duplicate">⎘</button>
                                <button class="btn-icon" onclick="deleteTask(${task.id})" title="Delete">🗑</button>
                            </div>
                        </div>
                        
                        <span class="urgency-badge urgency-${urgency.level}">${urgency.text}</span>
                        ${isEnergyMatched ? '<span class="urgency-badge" style="background: rgba(52, 199, 89, 0.2); color: var(--success); border-color: rgba(52, 199, 89, 0.4);">⚡ ENERGY MATCH</span>' : ''}
                        <span class="urgency-badge" style="background: ${dynamicUrgency.score >= 80 ? 'rgba(255,59,48,0.15)' : dynamicUrgency.score >= 50 ? 'rgba(255,149,0,0.15)' : 'rgba(52,199,89,0.15)'}; color: ${dynamicUrgency.score >= 80 ? 'var(--danger)' : dynamicUrgency.score >= 50 ? 'var(--warning)' : 'var(--success)'};  font-weight: 700;">🎯 ${dynamicUrgency.score}</span>
                        ${task.leadDays > 0 ? `<span class="urgency-badge" style="background: var(--gray-1); color: var(--text-secondary);">📅 ${task.leadDays} lead day${task.leadDays !== 1 ? 's' : ''}</span>` : ''}
                        
                        <div class="task-meta">
                            <div class="task-meta-item"><strong>Sprint:</strong> ${getSprintName(task.sprint)}</div>
                            <div class="task-meta-item"><strong>Deadline:</strong> ${autoDeadline.toLocaleDateString()}</div>
                            <div class="task-meta-item"><strong>Lead Days:</strong> ${task.leadDays}</div>
                            ${task.estimatedTime ? `<div class="task-meta-item"><strong>Est:</strong> ${task.estimatedTime}m</div>` : ''}
                            ${task.dependencies && task.dependencies.length > 0 ? `<div class="task-meta-item" style="grid-column: 1/-1;"><strong>Dependencies:</strong> ${task.dependencies.join(', ')}</div>` : ''}
                        </div>
                        
                        ${task.notes ? `<div class="task-notes">${task.notes}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function getSprintName(sprint) {
            const names = {
                urgent: '🔥 Urgent',
                deadlines: '⏰ Deadlines',
                admin: '📋 Admin',
                creative: '🎨 Creative'
            };
            return names[sprint] || sprint;
        }

        function toggleComplete(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                if (task.completed && task.timerRunning) stopTimer(id);
                if (task.completed) {
                    lastCompletedSprint = task.sprint;
                    localStorage.setItem('lastCompletedSprint', lastCompletedSprint);
                }
                saveTasks();
                renderTasks();
                updateStats();
                updateInsights();
            }
        }

        function deleteTask(id) {
            if (!confirm('Delete this task?')) {
                return; // User cancelled
            }
            
            try {
                // Remove from local array
                tasks = tasks.filter(t => t.id !== id);
                
                // Remove from projects
                projects.forEach(project => {
                    project.taskIds = project.taskIds.filter(taskId => taskId !== id);
                });
                
                // Save to localStorage immediately
                saveTasks();
                saveProjects();
                
                // Delete from Firestore (if online)
                if (useFirebase && currentUser) {
                    setSyncStatus('syncing');
                    const userRef = db.collection('users').doc(currentUser.uid);
                    userRef.collection('tasks').doc(String(id)).delete()
                        .then(() => {
                            console.log('Task deleted from Firestore');
                            setSyncStatus('synced');
                        })
                        .catch(error => {
                            console.error('Firestore delete error:', error);
                            // Still show synced because local delete worked
                            setSyncStatus('synced');
                        });
                }
                
                // Update UI
                renderTasks();
                updateStats();
                updateInsights();
                updateProjectFilters();
                updateDataLists();
                
            } catch (error) {
                console.error('Delete task error:', error);
                alert('Error deleting task. Please refresh the page and try again.');
            }
        }

        function duplicateTask(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                const newTask = {
                    ...task,
                    id: Date.now(),
                    name: task.name + ' (Copy)',
                    completed: false,
                    createdAt: new Date().toISOString(),
                    actualTime: 0,
                    timerRunning: false,
                    timerStart: null
                };
                tasks.push(newTask);
                saveTasks();
                renderTasks();
                updateStats();
            }
        }

        // Edit Task Functions
        function openEditModal(id) {
            editingTaskId = id;
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            
            document.getElementById('editModalContent').innerHTML = `
                <form id="editTaskForm" onsubmit="saveTaskEdit(event)">
                    <div class="form-group">
                        <label>Task Name</label>
                        <input type="text" id="editTaskName" value="${task.name}" required>
                    </div>
                    <div class="form-group">
                        <label>Sprint</label>
                        <select id="editTaskSprint">
                            <option value="urgent" ${task.sprint === 'urgent' ? 'selected' : ''}>Urgent</option>
                            <option value="deadlines" ${task.sprint === 'deadlines' ? 'selected' : ''}>Deadlines</option>
                            <option value="admin" ${task.sprint === 'admin' ? 'selected' : ''}>Admin</option>
                            <option value="creative" ${task.sprint === 'creative' ? 'selected' : ''}>Creative</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Project</label>
                        <input type="text" id="editTaskProject" value="${task.project || ''}" list="projectList">
                    </div>
                    <div class="form-group">
                        <label>Final Deadline</label>
                        <input type="date" id="editTaskDeadline" value="${task.finalDeadline}" required>
                    </div>
                    <div class="form-group">
                        <label>Lead Days</label>
                        <input type="number" id="editTaskLeadDays" value="${task.leadDays}" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label>Estimated Time (minutes)</label>
                        <input type="number" id="editTaskTime" value="${task.estimatedTime || ''}" min="5" step="5">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="editTaskNotes">${task.notes || ''}</textarea>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 24px;">
                        <button type="button" class="btn-secondary" onclick="closeEditModal()" style="flex: 1;">Cancel</button>
                        <button type="submit" class="btn-primary" style="flex: 1;">Save Changes</button>
                    </div>
                </form>
            `;
            
            document.getElementById('editModal').classList.add('active');
        }

        function saveTaskEdit(e) {
            e.preventDefault();
            const task = tasks.find(t => t.id === editingTaskId);
            if (!task) return;
            
            const oldProject = task.project;
            const newProject = document.getElementById('editTaskProject').value.trim();
            
            task.name = document.getElementById('editTaskName').value;
            task.sprint = document.getElementById('editTaskSprint').value;
            task.project = newProject || null;
            task.finalDeadline = document.getElementById('editTaskDeadline').value;
            task.leadDays = parseInt(document.getElementById('editTaskLeadDays').value) || 0;
            task.urgencyScore = getSprintBaseUrgency(document.getElementById('editTaskSprint').value);
            task.estimatedTime = parseInt(document.getElementById('editTaskTime').value) || 0;
            task.notes = document.getElementById('editTaskNotes').value;
            
            if (oldProject !== newProject) {
                if (oldProject) {
                    const oldProj = projects.find(p => p.name === oldProject);
                    if (oldProj) {
                        oldProj.taskIds = oldProj.taskIds.filter(id => id !== task.id);
                    }
                }
                
                if (newProject) {
                    let proj = projects.find(p => p.name === newProject);
                    if (!proj) {
                        proj = {
                            id: Date.now(),
                            name: newProject,
                            createdAt: new Date().toISOString(),
                            taskIds: []
                        };
                        projects.push(proj);
                    }
                    if (!proj.taskIds.includes(task.id)) {
                        proj.taskIds.push(task.id);
                    }
                }
                saveProjects();
            }
            
            saveTasks();
            renderTasks();
            updateStats();
            updateProjectFilters();
            updateDataLists();
            closeEditModal();
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingTaskId = null;
        }

        // Timer Functions
        function startTimer(id) {
            const runningTask = tasks.find(t => t.timerRunning);
            if (runningTask) {
                stopTimer(runningTask.id);
            }
            
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.timerRunning = true;
                task.timerStart = Date.now();
                runningTimerTaskId = id;
                saveTasks();
                renderTasks();
                showTimerDisplay(task);
            }
        }

        function stopTimer(id) {
            const task = tasks.find(t => t.id === id);
            if (task && task.timerRunning) {
                const elapsed = (Date.now() - task.timerStart) / 1000 / 60;
                task.actualTime = (task.actualTime || 0) + elapsed;
                task.timerRunning = false;
                task.timerStart = null;
                runningTimerTaskId = null;
                saveTasks();
                renderTasks();
                hideTimerDisplay();
            }
        }

        function stopTimerFromDisplay() {
            if (runningTimerTaskId) {
                stopTimer(runningTimerTaskId);
            }
        }

        function showTimerDisplay(task) {
            document.getElementById('timerTaskName').textContent = task.name;
            document.getElementById('runningTimerDisplay').classList.add('active');
            updateRunningTimerDisplay();
        }

        function hideTimerDisplay() {
            document.getElementById('runningTimerDisplay').classList.remove('active');
        }

        function closeTimerDisplay() {
            hideTimerDisplay();
        }

        function updateRunningTimerDisplay() {
            if (!runningTimerTaskId) return;
            
            const task = tasks.find(t => t.id === runningTimerTaskId);
            if (!task || !task.timerRunning) {
                hideTimerDisplay();
                return;
            }
            
            const elapsed = Math.floor((Date.now() - task.timerStart) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            document.getElementById('timerTime').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // Timer Panel Functions
        function populateTimerDropdown() {
            const dropdown = document.getElementById('timerTaskDropdown');
            if (!dropdown) return;
            
            const activeTasks = tasks.filter(t => !t.completed);
            
            dropdown.innerHTML = '<option value="">-- Select a task --</option>' + 
                activeTasks.map(task => `<option value="${task.id}">${task.name}</option>`).join('');
            
            // If there's a running timer, select that task
            if (runningTimerTaskId) {
                dropdown.value = runningTimerTaskId;
                updateTimerPanelDisplay(runningTimerTaskId);
            }
            
            dropdown.onchange = function() {
                const taskId = parseInt(this.value);
                if (taskId) {
                    updateTimerPanelDisplay(taskId);
                    document.getElementById('timerStartBtn').disabled = false;
                } else {
                    resetTimerPanelDisplay();
                }
            };
        }

        function updateTimerPanelDisplay(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;
            
            const timerDisplay = document.getElementById('timerDisplay');
            const timerTaskName = timerDisplay.querySelector('#timerTaskName');
            const timerTime = timerDisplay.querySelector('#timerTime');
            const startBtn = document.getElementById('timerStartBtn');
            const stopBtn = document.getElementById('timerStopBtn');
            const taskInfo = document.getElementById('timerTaskInfo');
            
            timerTaskName.textContent = task.name;
            
            if (task.timerRunning) {
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                updateTimerPanelTime();
            } else {
                startBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
                timerTime.textContent = '00:00';
            }
            
            // Show task info
            taskInfo.style.display = 'block';
            const autoDeadline = calculateAutoDeadline(task.finalDeadline, task.leadDays);
            document.getElementById('timerInfoSprint').textContent = getSprintName(task.sprint);
            document.getElementById('timerInfoDeadline').textContent = autoDeadline.toLocaleDateString();
            document.getElementById('timerInfoEstTime').textContent = task.estimatedTime ? task.estimatedTime + ' min' : 'Not set';
        }

        function resetTimerPanelDisplay() {
            const timerTaskName = document.getElementById('timerTaskName');
            const timerTime = document.getElementById('timerTime');
            const startBtn = document.getElementById('timerStartBtn');
            const stopBtn = document.getElementById('timerStopBtn');
            const taskInfo = document.getElementById('timerTaskInfo');
            
            timerTaskName.textContent = 'No task selected';
            timerTime.textContent = '00:00';
            startBtn.disabled = true;
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            taskInfo.style.display = 'none';
        }

        function startTimerFromPanel() {
            const dropdown = document.getElementById('timerTaskDropdown');
            const taskId = parseInt(dropdown.value);
            if (taskId) {
                startTimer(taskId);
                updateTimerPanelDisplay(taskId);
            }
        }

        function stopTimerFromPanel() {
            if (runningTimerTaskId) {
                stopTimer(runningTimerTaskId);
                updateTimerPanelDisplay(runningTimerTaskId);
            }
        }

        function updateTimerPanelTime() {
            if (!runningTimerTaskId) return;
            
            const task = tasks.find(t => t.id === runningTimerTaskId);
            if (!task || !task.timerRunning) return;
            
            const elapsed = Math.floor((Date.now() - task.timerStart) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            
            const timerTimeEl = document.querySelector('#timerDisplay #timerTime');
            if (timerTimeEl) {
                timerTimeEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
        }

        // Update timer panel every second if it's open
        setInterval(() => {
            const timerSection = document.getElementById('timerSection');
            if (timerSection && timerSection.classList.contains('active') && runningTimerTaskId) {
                updateTimerPanelTime();
            }
        }, 1000);

        // Project Filters
        function updateProjectFilters() {
            const container = document.getElementById('projectFilters');
            
            if (projects.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            container.innerHTML = `
                <div style="font-size: 13px; font-weight: 600; color: var(--text-tertiary); display: flex; align-items: center;">
                    Projects:
                </div>
                ${projects.map(project => {
                    const isActive = selectedProjectFilters.includes(project.name);
                    return `
                        <div class="project-filter-chip ${isActive ? 'active' : ''}" 
                             onclick="toggleProjectFilter('${project.name.replace(/'/g, "\\'")}')">
                            <span>${project.name}</span>
                            ${isActive ? `
                                <div style="display: flex; gap: 6px; margin-left: 6px;">
                                    <button class="btn-icon-tiny" onclick="event.stopPropagation(); editProject(${project.id})" title="Edit">✏</button>
                                    <button class="btn-icon-tiny" onclick="event.stopPropagation(); deleteProject(${project.id})" title="Delete">×</button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('')}
                ${selectedProjectFilters.length > 0 ? `
                    <button class="clear-filters" onclick="clearProjectFilters()">Clear</button>
                ` : ''}
            `;
        }

        function toggleProjectFilter(projectName) {
            const index = selectedProjectFilters.indexOf(projectName);
            if (index > -1) {
                selectedProjectFilters.splice(index, 1);
            } else {
                selectedProjectFilters.push(projectName);
            }
            updateProjectFilters();
            renderTasks();
        }

        function clearProjectFilters() {
            selectedProjectFilters = [];
            updateProjectFilters();
            renderTasks();
        }

        function editProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            document.getElementById('newProjectName').value = project.name;
            document.getElementById('newProjectDescription').value = project.description || '';
            document.getElementById('addProjectModal').classList.add('active');
            document.getElementById('addProjectModal').dataset.editingId = projectId;
            document.querySelector('#addProjectModal .modal-title').textContent = 'Edit Project';
            document.querySelector('#addProjectForm button[type="submit"]').textContent = 'Save Changes';
        }

        function deleteProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const tasksInProject = tasks.filter(t => t.project === project.name);
            
            let confirmMsg = `Delete project "${project.name}"?`;
            if (tasksInProject.length > 0) {
                confirmMsg += `\n\nThis will remove the project from ${tasksInProject.length} task(s), but the tasks will remain.`;
            }
            
            if (!confirm(confirmMsg)) return;
            
            // Remove project from tasks
            tasksInProject.forEach(task => {
                task.project = null;
            });
            
            // Remove from projects array
            projects = projects.filter(p => p.id !== projectId);
            
            // Remove from selected filters
            selectedProjectFilters = selectedProjectFilters.filter(name => name !== project.name);
            
            saveTasks();
            saveProjects();
            renderTasks();
            updateProjectFilters();
            updateProjectDropdowns();
            
            // Delete from Firestore
            if (useFirebase && currentUser) {
                const userRef = db.collection('users').doc(currentUser.uid);
                userRef.collection('projects').doc(String(projectId)).delete();
            }
        }

        // Template Builder Functions
        function showTemplateBuilder() {
            templateTasks = [];
            document.getElementById('templateBuilder').style.display = 'block';
            document.getElementById('showTemplateBuilderBtn').style.display = 'none';
            document.getElementById('newTemplateName').value = '';
            renderTemplateTasks();
        }

        function cancelTemplateBuilder() {
            templateTasks = [];
            document.getElementById('templateBuilder').style.display = 'none';
            document.getElementById('showTemplateBuilderBtn').style.display = 'block';
        }

        function addTemplateTask() {
            document.getElementById('templateTaskModal').classList.add('active');
        }

        function closeTemplateTaskModal() {
            document.getElementById('templateTaskModal').classList.remove('active');
            document.getElementById('templateTaskForm').reset();
        }

        document.getElementById('templateTaskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const templateTask = {
                name: document.getElementById('templateTaskName').value,
                sprint: document.getElementById('templateTaskSprint').value,
                leadDays: parseInt(document.getElementById('templateTaskLeadDays').value) || 0,
                estimatedTime: parseInt(document.getElementById('templateTaskTime').value) || 0,
                notes: document.getElementById('templateTaskNotes').value
            };
            
            templateTasks.push(templateTask);
            renderTemplateTasks();
            closeTemplateTaskModal();
        });

        function renderTemplateTasks() {
            const container = document.getElementById('templateTasksList');
            container.innerHTML = templateTasks.map((task, index) => `
                <div class="template-task-item">
                    <div class="template-task-info">
                        <div class="template-task-name">${task.name}</div>
                        <div class="template-task-details">
                            ${getSprintName(task.sprint)} • Lead: ${task.leadDays}d
                            ${task.estimatedTime ? ` • ${task.estimatedTime}m` : ''}
                        </div>
                    </div>
                    <button class="btn-icon" onclick="removeTemplateTask(${index})" type="button">🗑</button>
                </div>
            `).join('');
        }

        function removeTemplateTask(index) {
            templateTasks.splice(index, 1);
            renderTemplateTasks();
        }

        function saveNewTemplate() {
            const name = document.getElementById('newTemplateName').value.trim();
            
            if (!name) {
                alert('Please enter a template name');
                return;
            }
            
            if (templateTasks.length === 0) {
                alert('Please add at least one task');
                return;
            }
            
            const template = {
                id: Date.now(),
                name: name,
                tasks: templateTasks,
                createdAt: new Date().toISOString()
            };
            
            templates.push(template);
            saveTemplates();
            renderTemplates();
            cancelTemplateBuilder();
        }

        function saveCurrentAsTemplate() {
            const name = prompt('Template name:');
            if (!name) return;
            
            const activeTasks = tasks.filter(t => !t.completed);
            if (activeTasks.length === 0) {
                alert('No active tasks to save');
                return;
            }
            
            const template = {
                id: Date.now(),
                name: name,
                tasks: activeTasks.map(t => ({
                    name: t.name,
                    sprint: t.sprint,
                    leadDays: t.leadDays,
                    estimatedTime: t.estimatedTime,
                    notes: t.notes
                })),
                createdAt: new Date().toISOString()
            };
            
            templates.push(template);
            saveTemplates();
            renderTemplates();
        }

        function renderTemplates() {
            const container = document.getElementById('templateList');
            
            if (templates.length === 0) {
                container.innerHTML = '<p style="color: var(--text-tertiary); font-size: 13px; margin-top: 14px;">No templates yet</p>';
                return;
            }
            
            container.innerHTML = templates.map(template => `
                <div class="template-item">
                    <div class="template-info">
                        <div class="template-name">${template.name}</div>
                        <div class="template-count">${template.tasks.length} tasks</div>
                    </div>
                    <div class="template-actions">
                        <button class="btn-small btn-primary" onclick="loadTemplate(${template.id})">Load</button>
                        <button class="btn-small" style="background: var(--danger); color: white;" onclick="deleteTemplate(${template.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function loadTemplate(id) {
            const template = templates.find(t => t.id === id);
            if (!template) return;
            
            const days = prompt('Deadline in how many days?', '7');
            if (!days || days === '') return;
            
            const daysNum = parseInt(days);
            if (isNaN(daysNum)) {
                alert('Please enter a valid number');
                return;
            }
            
            const finalDeadline = new Date();
            finalDeadline.setDate(finalDeadline.getDate() + daysNum);
            const finalDeadlineStr = finalDeadline.toISOString().split('T')[0];
            
            template.tasks.forEach((taskTemplate, index) => {
                const task = {
                    id: Date.now() + index,
                    name: taskTemplate.name,
                    sprint: taskTemplate.sprint,
                    project: null,
                    finalDeadline: finalDeadlineStr,
                    leadDays: taskTemplate.leadDays || 0,
                    estimatedTime: taskTemplate.estimatedTime || 0,
                    notes: taskTemplate.notes || '',
                    dependencies: [],
                    completed: false,
                    createdAt: new Date().toISOString(),
                    actualTime: 0,
                    timerRunning: false,
                    timerStart: null
                };
                tasks.push(task);
            });
            
            saveTasks();
            renderTasks();
            updateStats();
            updateInsights();
        }

        function deleteTemplate(id) {
            if (confirm('Delete this template?')) {
                templates = templates.filter(t => t.id !== id);
                saveTemplates();
                renderTemplates();
            }
        }

        // Filter Functions
        function filterBySprint(sprint) {
            currentSprintFilter = sprint;
            document.querySelectorAll('.sprint-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            renderTasks();
        }

        function filterTasks(status) {
            currentStatusFilter = status;
            document.querySelectorAll('#listView .segment').forEach(seg => seg.classList.remove('active'));
            event.target.classList.add('active');
            renderTasks();
        }

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.main-content .segmented-control .segment').forEach(seg => seg.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('listView').style.display = view === 'list' ? 'block' : 'none';
            document.getElementById('sprintView').style.display = view === 'sprint' ? 'block' : 'none';
            document.getElementById('projectsView').style.display = view === 'projects' ? 'block' : 'none';
        }

        // Energy Functions
        function setEnergy(level) {
            currentEnergy = level;
            localStorage.setItem('currentEnergy', level);
            
            document.querySelectorAll('.energy-option').forEach(opt => opt.classList.remove('active'));
            document.getElementById(`energy${level.charAt(0).toUpperCase() + level.slice(1)}`).classList.add('active');
            
            const recommendations = {
                low: "Low energy detected - Focus on simple admin tasks or take a break",
                medium: "Good energy for urgent tasks and deadlines",
                high: "High energy! Perfect time for creative work and challenging tasks"
            };
            
            document.getElementById('energyRecommendation').textContent = recommendations[level];
            updateInsights();
            renderTasks(); // Re-render tasks to show energy highlighting
        }

        // Stats Functions
        function updateStats() {
            const total = tasks.length;
            const completed = tasks.filter(t => t.completed).length;
            const urgent = tasks.filter(t => {
                if (t.completed) return false;
                const autoDeadline = calculateAutoDeadline(t.finalDeadline, t.leadDays);
                const urgency = calculateUrgency(autoDeadline);
                console.log(`Task "${t.name}": urgency level = ${urgency.level}`);
                return urgency.level === 'past-due' || urgency.level === 'due-today';
            }).length;
            
            console.log('Stats:', { total, completed, urgent });
            
            const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            const completedWithTime = tasks.filter(t => t.completed && t.estimatedTime > 0 && t.actualTime > 0);
            let avgAccuracy = '--';
            if (completedWithTime.length > 0) {
                const accuracies = completedWithTime.map(t => {
                    const diff = Math.abs(t.estimatedTime - t.actualTime);
                    return Math.max(0, 100 - (diff / t.estimatedTime) * 100);
                });
                avgAccuracy = Math.round(accuracies.reduce((a, b) => a + b, 0) / accuracies.length) + '%';
            }
            
            document.getElementById('totalTasks').textContent = total;
            document.getElementById('urgentTasks').textContent = urgent;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('completionRate').textContent = completionRate + '%';
            document.getElementById('avgAccuracy').textContent = avgAccuracy;
            
            // Update mobile stats too
            updateMobileStats();
        }

        function updateInsights() {
            const insights = [];
            const activeTasks = tasks.filter(t => !t.completed);
            const urgentTasks = activeTasks.filter(t => {
                const autoDeadline = calculateAutoDeadline(t.finalDeadline, t.leadDays);
                const urgency = calculateUrgency(autoDeadline);
                return urgency.level === 'past-due' || urgency.level === 'due-today';
            });
            
            // Energy-based insight
            if (currentEnergy === 'high') {
                const creativeTasks = activeTasks.filter(t => t.sprint === 'creative');
                if (creativeTasks.length > 0) {
                    insights.push({
                        icon: '⚡',
                        title: 'Peak Performance Window',
                        text: `You have ${creativeTasks.length} creative task(s) ready. Research shows high-energy periods are ideal for complex problem-solving. Strike while the iron is hot!`
                    });
                } else {
                    insights.push({
                        icon: '🎯',
                        title: 'High Energy Available',
                        text: 'Your energy is high but no creative tasks queued. Consider tackling your most challenging work now—this peak won\'t last forever!'
                    });
                }
            } else if (currentEnergy === 'low') {
                const adminTasks = activeTasks.filter(t => t.sprint === 'admin');
                if (adminTasks.length > 0) {
                    insights.push({
                        icon: '🌱',
                        title: 'Low Energy, High Value',
                        text: `Perfect time for ${adminTasks.length} admin task(s). Studies show routine tasks during low energy preserve cognitive resources for later. You're being strategic!`
                    });
                }
            }
            
            // Context switching warning (based on Attention Residue research)
            const activeSprints = [...new Set(activeTasks.map(t => t.sprint))];
            if (activeSprints.length > 2) {
                insights.push({
                    icon: '🧠',
                    title: 'Attention Residue Alert',
                    text: `You have tasks in ${activeSprints.length} different sprints. Sophie Leroy's research shows switching between task types leaves "attention residue" that reduces performance. Consider batching similar tasks.`
                });
            }
            
            // Urgency insight (Time Pressure research)
            if (urgentTasks.length > 3) {
                insights.push({
                    icon: '🚨',
                    title: 'Stress Load Warning',
                    text: `${urgentTasks.length} urgent tasks detected. The Yerkes-Dodson law shows too much pressure decreases performance. Prioritize ruthlessly—what can wait or be delegated?`
                });
            } else if (urgentTasks.length > 0) {
                insights.push({
                    icon: '🎯',
                    title: 'Optimal Pressure Zone',
                    text: `${urgentTasks.length} urgent task(s) provide healthy pressure. Research shows moderate time pressure enhances focus. You're in the sweet spot!`
                });
            }
            
            // Task completion momentum (Implementation Intentions)
            const recentlyCompleted = tasks.filter(t => {
                if (!t.completed) return false;
                const completedDate = new Date(t.createdAt);
                const hoursSince = (Date.now() - completedDate) / (1000 * 60 * 60);
                return hoursSince < 24;
            }).length;
            
            if (recentlyCompleted > 0) {
                insights.push({
                    icon: '🔥',
                    title: 'Momentum Building',
                    text: `${recentlyCompleted} task(s) completed today! The Zeigarnik effect shows completing tasks releases mental tension. Keep the streak going!`
                });
            }
            
            // Break reminder (Ultradian Rhythms)
            const activeTimers = activeTasks.filter(t => t.timerRunning);
            if (activeTimers.length > 0 && activeTimers[0].timerStart) {
                const minutesWorking = (Date.now() - activeTimers[0].timerStart) / (1000 * 60);
                if (minutesWorking > 90) {
                    insights.push({
                        icon: '☕',
                        title: 'Ultradian Break Time',
                        text: 'You\'ve been working for over 90 minutes. Research on ultradian rhythms shows our focus naturally dips every 90-120 minutes. A 10-15 minute break will restore peak performance.'
                    });
                }
            }
            
            // Time estimation insight (Planning Fallacy)
            const tasksWithEstimates = activeTasks.filter(t => t.estimatedTime > 0);
            const totalEstimatedTime = tasksWithEstimates.reduce((sum, t) => sum + t.estimatedTime, 0);
            if (totalEstimatedTime > 480) { // More than 8 hours
                insights.push({
                    icon: '⏰',
                    title: 'Planning Fallacy Check',
                    text: `Your tasks add up to ${Math.round(totalEstimatedTime/60)} hours. Kahneman's research shows we typically underestimate by 40%. Real time needed might be ${Math.round(totalEstimatedTime * 1.4 / 60)} hours.`
                });
            }
            
            // Empty state - positive reinforcement
            if (activeTasks.length === 0) {
                insights.push({
                    icon: '✨',
                    title: 'Clean Slate',
                    text: 'No active tasks! This is your chance to plan mindfully. Research shows planning during low cognitive load leads to better task selection and sequencing.'
                });
            }
            
            // Show insights in speech bubble
            displayCatInsights(insights);
        }

        function displayCatInsights(insights) {
            const container = document.getElementById('catInsightsContent');
            
            if (insights.length === 0) {
                container.innerHTML = `
                    <div class="insight-item">
                        <span class="insight-icon">😺</span>
                        <div>
                            <div class="insight-title">All Good Here!</div>
                            <div class="insight-text">You're doing great. Keep up the good work!</div>
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = insights.map(insight => `
                    <div class="insight-item">
                        <div>
                            <div class="insight-title">
                                <span class="insight-icon">${insight.icon}</span>
                                ${insight.title}
                            </div>
                            <div class="insight-text">${insight.text}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function toggleInsights() {
            const bubble = document.getElementById('catSpeechBubble');
            
            if (bubble.style.display === 'none' || !bubble.style.display) {
                bubble.style.display = 'block';
                updateInsights(); // Refresh insights when opening
            } else {
                bubble.style.display = 'none';
            }
        }

        function closeCatInsights() {
            document.getElementById('catSpeechBubble').style.display = 'none';
        }

        // Make cat clickable to show insights
        document.addEventListener('DOMContentLoaded', function() {
            const catLogo = document.getElementById('catLogo');
            if (catLogo) {
                catLogo.addEventListener('click', toggleInsights);
            }
        });

        function checkContextSwitching(newSprint) {
            if (lastCompletedSprint && lastCompletedSprint !== newSprint) {
                const sprintNames = {
                    urgent: 'Urgent', deadlines: 'Deadlines',
                    admin: 'Admin', creative: 'Creative'
                };
                document.getElementById('lastSprint').textContent = sprintNames[lastCompletedSprint];
                document.getElementById('contextAlert').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('contextAlert').style.display = 'none';
                }, 10000);
            }
        }

        function updateDataLists() {
            // Update task dependencies lists
            const tasksList = document.getElementById('tasksList');
            tasksList.innerHTML = tasks.filter(t => !t.completed).map(t => `<option value="${t.name}">`).join('');
            
            const mobileTasksList = document.getElementById('mobileTasksList');
            if (mobileTasksList) {
                mobileTasksList.innerHTML = tasks.filter(t => !t.completed).map(t => `<option value="${t.name}">`).join('');
            }
            
            // Update project dropdowns
            updateProjectDropdowns();
        }

        function updateProjectDropdowns() {
            const projectSelect = document.getElementById('projectName');
            const mobileProjectSelect = document.getElementById('mobileProjectName');
            
            const projectOptions = '<option value="">No Project</option>' + 
                projects.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
            
            if (projectSelect) {
                const currentValue = projectSelect.value;
                projectSelect.innerHTML = projectOptions;
                projectSelect.value = currentValue;
            }
            
            if (mobileProjectSelect) {
                const currentValue = mobileProjectSelect.value;
                mobileProjectSelect.innerHTML = projectOptions;
                mobileProjectSelect.value = currentValue;
            }
        }

        // Project Modal Functions
        function showAddProjectModal() {
            document.getElementById('addProjectModal').classList.add('active');
            setTimeout(() => {
                document.getElementById('newProjectName').focus();
            }, 100);
        }

        function closeAddProjectModal() {
            const modal = document.getElementById('addProjectModal');
            modal.classList.remove('active');
            document.getElementById('addProjectForm').reset();
            delete modal.dataset.editingId;
            document.querySelector('#addProjectModal .modal-title').textContent = 'New Project';
            document.querySelector('#addProjectForm button[type="submit"]').textContent = 'Create Project';
        }

        // Add Project Form Handler
        document.getElementById('addProjectForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('newProjectName').value.trim();
            const description = document.getElementById('newProjectDescription').value.trim();
            const editingId = document.getElementById('addProjectModal').dataset.editingId;
            
            if (editingId) {
                // Edit existing project
                const project = projects.find(p => p.id === parseInt(editingId));
                if (project) {
                    const oldName = project.name;
                    project.name = name;
                    project.description = description;
                    
                    // Update project name in all tasks
                    tasks.forEach(task => {
                        if (task.project === oldName) {
                            task.project = name;
                        }
                    });
                    
                    // Update in selected filters
                    const filterIndex = selectedProjectFilters.indexOf(oldName);
                    if (filterIndex > -1) {
                        selectedProjectFilters[filterIndex] = name;
                    }
                    
                    saveTasks();
                    saveProjects();
                    renderTasks();
                }
                
                delete document.getElementById('addProjectModal').dataset.editingId;
            } else {
                // Create new project
                // Check if project already exists
                if (projects.find(p => p.name.toLowerCase() === name.toLowerCase())) {
                    alert('A project with this name already exists');
                    return;
                }
                
                const project = {
                    id: Date.now(),
                    name: name,
                    description: description,
                    createdAt: new Date().toISOString(),
                    taskIds: []
                };
                
                projects.push(project);
                saveProjects();
                
                // Select the new project in the dropdown
                const projectSelect = document.getElementById('projectName');
                const mobileProjectSelect = document.getElementById('mobileProjectName');
                if (projectSelect) projectSelect.value = name;
                if (mobileProjectSelect) mobileProjectSelect.value = name;
            }
            
            updateProjectDropdowns();
            updateProjectFilters();
            closeAddProjectModal();
        });

        // Mobile Navigation Functions
        function showMobilePage(page) {
            // Hide all mobile pages
            document.querySelectorAll('.mobile-page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.mobile-nav-item').forEach(i => i.classList.remove('active'));
            
            // Show selected page
            if (page === 'tasks') {
                document.getElementById('mobileTasks').classList.add('active');
                document.querySelectorAll('.mobile-nav-item')[0].classList.add('active');
                renderMobileTasks();
            } else if (page === 'add') {
                document.getElementById('mobileAddTask').classList.add('active');
                document.querySelectorAll('.mobile-nav-item')[1].classList.add('active');
            } else if (page === 'stats') {
                document.getElementById('mobileStats').classList.add('active');
                document.querySelectorAll('.mobile-nav-item')[2].classList.add('active');
                updateMobileStats();
            } else if (page === 'energy') {
                document.getElementById('mobileEnergy').classList.add('active');
                document.querySelectorAll('.mobile-nav-item')[3].classList.add('active');
                syncEnergyButtons();
            }
        }

        // Render tasks in mobile view
        function renderMobileTasks() {
            const container = document.getElementById('mobileTasksContainer');
            if (!container) return;
            
            let activeTasks = tasks.filter(t => !t.completed);
            activeTasks = sortTasks(activeTasks);

            if (activeTasks.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">✓</div><p>No active tasks</p></div>';
                return;
            }

            // Energy matching for highlighting
            const energyMatch = {
                low: 'admin',
                medium: ['urgent', 'deadlines'],
                high: 'creative'
            };

            container.innerHTML = activeTasks.map(task => {
                const autoDeadline = calculateAutoDeadline(task.finalDeadline, task.leadDays);
                const urgency = calculateUrgency(autoDeadline);
                
                let isEnergyMatched = false;
                if (currentEnergy === 'low' && task.sprint === energyMatch.low) {
                    isEnergyMatched = true;
                } else if (currentEnergy === 'medium' && energyMatch.medium.includes(task.sprint)) {
                    isEnergyMatched = true;
                } else if (currentEnergy === 'high' && task.sprint === energyMatch.high) {
                    isEnergyMatched = true;
                }
                
                return `
                    <div class="task-card ${isEnergyMatched ? 'energy-matched' : ''}">
                        <div class="task-header">
                            <div class="task-title">${task.name}</div>
                            <div class="task-actions">
                                <button class="btn-icon" onclick="toggleComplete(${task.id})">○</button>
                                <button class="btn-icon" onclick="deleteTask(${task.id})">🗑</button>
                            </div>
                        </div>
                        <span class="urgency-badge urgency-${urgency.level}">${urgency.text}</span>
                        ${isEnergyMatched ? '<span class="urgency-badge" style="background: rgba(52, 199, 89, 0.2); color: var(--success);">⚡ MATCH</span>' : ''}
                        <div class="task-meta">
                            <div>${getSprintName(task.sprint)}</div>
                            <div>${autoDeadline.toLocaleDateString()}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update mobile stats
        function updateMobileStats() {
            document.getElementById('mobileTotalTasks').textContent = document.getElementById('totalTasks').textContent;
            document.getElementById('mobileUrgentTasks').textContent = document.getElementById('urgentTasks').textContent;
            document.getElementById('mobileCompletedTasks').textContent = document.getElementById('completedTasks').textContent;
            document.getElementById('mobileCompletionRate').textContent = document.getElementById('completionRate').textContent;
            document.getElementById('mobileAvgAccuracy').textContent = document.getElementById('avgAccuracy').textContent;
        }

        // Sync energy buttons between desktop and mobile
        function syncEnergyButtons() {
            // Sync mobile energy buttons with current state
            document.querySelectorAll('#mobileEnergy .energy-option').forEach(opt => opt.classList.remove('active'));
            const mobileEnergyBtn = document.getElementById(`mobileEnergy${currentEnergy.charAt(0).toUpperCase() + currentEnergy.slice(1)}`);
            if (mobileEnergyBtn) {
                mobileEnergyBtn.classList.add('active');
            }
            
            // Update recommendation
            const recommendations = {
                low: "Low energy detected - Focus on simple admin tasks or take a break",
                medium: "Good energy for urgent tasks and deadlines",
                high: "High energy! Perfect time for creative work and challenging tasks"
            };
            const mobileRec = document.getElementById('mobileEnergyRecommendation');
            if (mobileRec) {
                mobileRec.textContent = recommendations[currentEnergy];
            }
        }

        // Mobile task form submission
        document.getElementById('mobileTaskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const projectName = document.getElementById('mobileProjectName').value.trim();
            const dependenciesInput = document.getElementById('mobileDependencies').value.trim();
            const dependenciesArray = dependenciesInput ? dependenciesInput.split(',').map(d => d.trim()).filter(d => d) : [];
            
            const task = {
                id: Date.now(),
                name: document.getElementById('mobileTaskName').value,
                sprint: document.getElementById('mobileSprintCategory').value,
                project: projectName || null,
                finalDeadline: document.getElementById('mobileFinalDeadline').value,
                leadDays: parseInt(document.getElementById('mobileLeadDays').value) || 0,
                estimatedTime: parseInt(document.getElementById('mobileEstimatedTime').value) || 0,
                notes: document.getElementById('mobileTaskNotes').value,
                dependencies: dependenciesArray,
                completed: false,
                createdAt: new Date().toISOString(),
                actualTime: 0,
                timerRunning: false,
                timerStart: null
            };
            
            tasks.push(task);
            
            if (projectName) {
                let project = projects.find(p => p.name === projectName);
                if (project && !project.taskIds.includes(task.id)) {
                    project.taskIds.push(task.id);
                    saveProjects();
                }
            }
            
            saveTasks();
            renderTasks();
            renderMobileTasks();
            updateStats();
            updateMobileStats();
            updateInsights();
            updateProjectFilters();
            updateDataLists();
            
            this.reset();
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('mobileFinalDeadline').value = tomorrow.toISOString().split('T')[0];
            
            // Switch to tasks page after adding
            showMobilePage('tasks');
        });

        // Dark Mode
        function toggleDarkMode() {
            const isDark = document.getElementById('darkModeToggle').checked;
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            localStorage.setItem('darkMode', isDark);
        }

        // Load dark mode preference
        function loadDarkMode() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            document.getElementById('darkModeToggle').checked = darkMode;
            if (darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        }

        // Sort Tasks
        function changeSortOrder(order) {
            currentSortOrder = order;
            renderTasks();
        }

        function sortTasks(tasksArray) {
            if (currentSortOrder === 'urgency') {
                return tasksArray.sort((a, b) => {
                    const aUrgency = calculateDynamicUrgency(a);
                    const bUrgency = calculateDynamicUrgency(b);
                    return bUrgency.score - aUrgency.score; // Higher urgency first
                });
            } else if (currentSortOrder === 'deadline') {
                return tasksArray.sort((a, b) => {
                    const aDeadline = calculateAutoDeadline(a.finalDeadline, a.leadDays);
                    const bDeadline = calculateAutoDeadline(b.finalDeadline, b.leadDays);
                    return aDeadline - bDeadline;
                });
            } else if (currentSortOrder === 'created') {
                return tasksArray.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }
            return tasksArray;
        }

        // Sprint Categories Management
        function renderSprintCategories() {
            const container = document.getElementById('sprintCategoriesList');
            container.innerHTML = sprintCategories.map(sprint => `
                <div class="sprint-category-item">
                    <div class="sprint-category-info">
                        <div class="sprint-category-icon">${sprint.icon}</div>
                        <div>
                            <div class="sprint-category-name">${sprint.name}</div>
                            ${sprint.energy ? `<div class="sprint-category-energy">Energy: ${sprint.energy}</div>` : ''}
                            <div class="sprint-category-energy">Base Urgency: ${sprint.baseUrgency || 50}</div>
                        </div>
                    </div>
                    <div class="sprint-category-actions">
                        <button class="btn-icon-tiny" onclick="editSprintCategory('${sprint.id}')" title="Edit">✏</button>
                        ${sprint.deletable !== false ? `
                            <button class="btn-icon-tiny" onclick="deleteSprintCategory('${sprint.id}')" title="Delete">×</button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function showAddSprintModal() {
            document.getElementById('sprintModalTitle').textContent = 'New Sprint Category';
            document.getElementById('sprintForm').reset();
            delete document.getElementById('sprintModal').dataset.editingId;
            document.getElementById('sprintModal').classList.add('active');
        }

        function editSprintCategory(sprintId) {
            const sprint = sprintCategories.find(s => s.id === sprintId);
            if (!sprint) return;
            
            document.getElementById('sprintModalTitle').textContent = 'Edit Sprint Category';
            document.getElementById('sprintName').value = sprint.name;
            document.getElementById('sprintIcon').value = sprint.icon;
            document.getElementById('sprintEnergy').value = sprint.energy || '';
            document.getElementById('sprintModal').dataset.editingId = sprintId;
            document.getElementById('sprintModal').classList.add('active');
        }

        function deleteSprintCategory(sprintId) {
            const sprint = sprintCategories.find(s => s.id === sprintId);
            if (!sprint) return;
            
            const tasksInSprint = tasks.filter(t => t.sprint === sprintId);
            if (tasksInSprint.length > 0) {
                if (!confirm(`Delete "${sprint.name}"?\n\n${tasksInSprint.length} task(s) will be moved to "Urgent".`)) {
                    return;
                }
                // Move tasks to urgent
                tasksInSprint.forEach(t => t.sprint = 'urgent');
                saveTasks();
            } else {
                if (!confirm(`Delete "${sprint.name}"?`)) return;
            }
            
            sprintCategories = sprintCategories.filter(s => s.id !== sprintId);
            localStorage.setItem('sprintCategories', JSON.stringify(sprintCategories));
            renderSprintCategories();
            updateSprintTabs();
            updateSprintDropdowns();
            renderTasks();
        }

        function closeSprintModal() {
            document.getElementById('sprintModal').classList.remove('active');
            delete document.getElementById('sprintModal').dataset.editingId;
        }

        // Sprint Form Handler
        document.getElementById('sprintForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('sprintName').value.trim();
            const icon = document.getElementById('sprintIcon').value.trim();
            const energy = document.getElementById('sprintEnergy').value;
            const editingId = document.getElementById('sprintModal').dataset.editingId;
            
            if (editingId) {
                // Edit existing
                const sprint = sprintCategories.find(s => s.id === editingId);
                if (sprint) {
                    sprint.name = name;
                    sprint.icon = icon;
                    sprint.energy = energy || null;
                }
            } else {
                // Add new
                const id = name.toLowerCase().replace(/\s+/g, '-');
                if (sprintCategories.find(s => s.id === id)) {
                    alert('A sprint with this name already exists');
                    return;
                }
                
                sprintCategories.push({
                    id: id,
                    name: name,
                    icon: icon,
                    energy: energy || null,
                    deletable: true
                });
            }
            
            localStorage.setItem('sprintCategories', JSON.stringify(sprintCategories));
            renderSprintCategories();
            updateSprintTabs();
            updateSprintDropdowns();
            closeSprintModal();
        });

        function updateSprintTabs() {
            // Update sprint tabs in main view
            const sprintTabs = document.querySelector('.sprint-tabs');
            if (!sprintTabs) return;
            
            sprintTabs.innerHTML = `
                <div class="sprint-tab active" onclick="filterBySprint('all')">All</div>
                ${sprintCategories.map(sprint => `
                    <div class="sprint-tab" id="sprintTab-${sprint.id}" onclick="filterBySprint('${sprint.id}')">
                        ${sprint.icon} ${sprint.name}
                    </div>
                `).join('')}
            `;
        }

        function updateSprintDropdowns() {
            // Update sprint dropdowns in forms
            const sprintSelects = [
                document.getElementById('sprintCategory'),
                document.getElementById('mobileSprintCategory'),
                document.getElementById('editTaskSprint'),
                document.getElementById('templateTaskSprint')
            ];
            
            sprintSelects.forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = sprintCategories.map(sprint => 
                    `<option value="${sprint.id}">${sprint.icon} ${sprint.name}</option>`
                ).join('');
                if (currentValue && sprintCategories.find(s => s.id === currentValue)) {
                    select.value = currentValue;
                }
            });
        }

        function loadSprintCategories() {
            const saved = localStorage.getItem('sprintCategories');
            if (saved) {
                sprintCategories = JSON.parse(saved);
                updateSprintTabs();
                updateSprintDropdowns();
            }
        }

        // Close modals on outside click
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) closeEditModal();
        });
        
        document.getElementById('templateTaskModal').addEventListener('click', function(e) {
            if (e.target === this) closeTemplateTaskModal();
        });
        
        document.getElementById('addProjectModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddProjectModal();
        });
        
        document.getElementById('sprintModal').addEventListener('click', function(e) {
            if (e.target === this) closeSprintModal();
        });

        // Initialize settings on load
        setTimeout(() => {
            loadDarkMode();
            loadSprintCategories();
        }, 100);
    

        // Scroll to Add Task section
        function scrollToAddTask() {
            const addTaskSection = document.getElementById('addTaskSection');
            if (addTaskSection) {
                addTaskSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Give focus to the task name input
                setTimeout(() => {
                    const taskNameInput = document.getElementById('taskName');
                    if (taskNameInput) taskNameInput.focus();
                }, 500);
            }
        }

        // Get sprint base urgency
        function getSprintBaseUrgency(sprintId) {
            const sprint = sprintCategories.find(s => s.id === sprintId);
            return sprint && sprint.baseUrgency ? sprint.baseUrgency : 50;
        }

        // Calculate dynamic urgency score
        function calculateDynamicUrgency(task) {
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            
            const finalDeadline = new Date(task.finalDeadline);
            finalDeadline.setHours(0, 0, 0, 0);
            
            const leadDays = parseInt(task.leadDays) || 0;
            const effectiveDeadline = new Date(finalDeadline);
            effectiveDeadline.setDate(effectiveDeadline.getDate() - leadDays);
            
            const daysUntilEffective = Math.floor((effectiveDeadline - now) / (1000 * 60 * 60 * 24));
            const daysUntilFinal = Math.floor((finalDeadline - now) / (1000 * 60 * 60 * 24));
            
            let baseUrgency = task.urgencyScore || 50;
            let dynamicUrgency = baseUrgency;
            
            if (daysUntilEffective <= 0) {
                dynamicUrgency = 100;
            } else if (daysUntilEffective <= 1) {
                dynamicUrgency = Math.max(baseUrgency, 90);
            } else if (daysUntilEffective <= 3) {
                dynamicUrgency = Math.max(baseUrgency, 75);
            } else if (daysUntilEffective <= 7) {
                dynamicUrgency = Math.max(baseUrgency, 60);
            }
            
            if (daysUntilFinal < 0) {
                dynamicUrgency = 100;
            }
            
            return {
                score: dynamicUrgency,
                daysUntilEffective: daysUntilEffective,
                daysUntilFinal: daysUntilFinal
            };
        }

    </script>
</body>
</html>
